<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">






  
  
  <link rel="stylesheet" media="all" href="/lib/Han/dist/han.min.css?v=3.3">




<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css">


  <meta name="keywords" content="图形图像,音视频,Camera,">








  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.2">






<meta name="description" content="​    抖音/快手等短视频APP的风靡，让音视频成为当下最火热的技术，越来越多的人想要进入到这个领域，我自己也是从图形方向刚刚踏入这领域不久，音视频方向所包含的技术栈非常复杂，我自己也在一点一点慢慢钻研，这里面每一个方向都值得深入研究，而且随着5G时代的到来，音视频方向的应用会更加广泛，所以希望自己能掌握更多的关于音视频方向的技能，未来可以探索更多的音视频玩法。然后这篇博客主要是想梳理一下我自己">
<meta name="keywords" content="图形图像,音视频,Camera">
<meta property="og:type" content="article">
<meta property="og:title" content="我的音视频技术路线">
<meta property="og:url" content="http://yoursite.com/2020/03/30/（url中显示的标题）/index.html">
<meta property="og:site_name" content="I am no one">
<meta property="og:description" content="​    抖音/快手等短视频APP的风靡，让音视频成为当下最火热的技术，越来越多的人想要进入到这个领域，我自己也是从图形方向刚刚踏入这领域不久，音视频方向所包含的技术栈非常复杂，我自己也在一点一点慢慢钻研，这里面每一个方向都值得深入研究，而且随着5G时代的到来，音视频方向的应用会更加广泛，所以希望自己能掌握更多的关于音视频方向的技能，未来可以探索更多的音视频玩法。然后这篇博客主要是想梳理一下我自己">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://i.loli.net/2020/03/30/XOIjb1L9vAak2Zs.jpg">
<meta property="og:image" content="https://i.loli.net/2020/03/30/YwbtVpLrKUPCX97.png">
<meta property="og:image" content="https://i.loli.net/2020/03/30/xBLf8olEGuO3FAq.png">
<meta property="og:image" content="https://i.loli.net/2020/03/30/QrSPgaK8Y1N6VUL.png">
<meta property="og:image" content="https://i.loli.net/2020/03/30/4tjRNxuId9657Ma.png">
<meta property="og:image" content="https://i.loli.net/2020/03/30/lXpri2536NO7cmI.png">
<meta property="og:image" content="https://i.loli.net/2020/03/30/a8FhiQmOTnA5Lzk.png">
<meta property="og:image" content="https://i.loli.net/2020/03/30/uyAKFm3Q5n4pDeb.png">
<meta property="og:image" content="https://i.loli.net/2020/03/30/JY8ZePXxi4M9WSC.png">
<meta property="og:image" content="https://i.loli.net/2020/03/30/uRghixNCAPSlbVs.png">
<meta property="og:image" content="https://i.loli.net/2020/03/30/8afbrAPmGDF9hq5.png">
<meta property="og:image" content="https://i.loli.net/2020/03/30/qMcWOY5Ng24LH9D.png">
<meta property="og:image" content="https://i.loli.net/2020/03/30/a7jLmSHZ9tNFEwO.png">
<meta property="og:image" content="https://i.loli.net/2020/03/30/tZvFGQOlMb13kTd.png">
<meta property="og:image" content="https://i.loli.net/2020/03/30/GutfwzVTk2LlC1h.png">
<meta property="og:image" content="https://i.loli.net/2020/03/30/sPNvIylF56gkYzQ.png">
<meta property="og:image" content="https://i.loli.net/2020/03/30/WlHf3MyvSE5XI61.jpg">
<meta property="og:image" content="https://i.loli.net/2020/03/30/pb9zQeStANWLZf1.png">
<meta property="og:image" content="https://i.loli.net/2020/03/30/Eng8sV6jF1NQfdr.png">
<meta property="og:image" content="https://i.loli.net/2020/03/30/1edpLhX8VuN9HwI.png">
<meta property="og:updated_time" content="2020-03-31T01:55:06.099Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="我的音视频技术路线">
<meta name="twitter:description" content="​    抖音/快手等短视频APP的风靡，让音视频成为当下最火热的技术，越来越多的人想要进入到这个领域，我自己也是从图形方向刚刚踏入这领域不久，音视频方向所包含的技术栈非常复杂，我自己也在一点一点慢慢钻研，这里面每一个方向都值得深入研究，而且随着5G时代的到来，音视频方向的应用会更加广泛，所以希望自己能掌握更多的关于音视频方向的技能，未来可以探索更多的音视频玩法。然后这篇博客主要是想梳理一下我自己">
<meta name="twitter:image" content="https://i.loli.net/2020/03/30/XOIjb1L9vAak2Zs.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/03/30/（url中显示的标题）/">





  <title>我的音视频技术路线 | I am no one</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">I am no one</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Some people choose to see the ugliness in this world, the disarray. I choose to see the beauty.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/30/（url中显示的标题）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanglusheng">
      <meta itemprop="description" content>
      <meta itemprop="image" content="http://ovi6hpv55.bkt.clouddn.com/%E5%A4%B4%E5%83%8F.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="I am no one">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">我的音视频技术路线</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-30T21:34:21+08:00">
                2020-03-30
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/音视频/" itemprop="url" rel="index">
                    <span itemprop="name">音视频</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-comment-o"></i>
              </span>
              
                <a href="/2020/03/30/（url中显示的标题）/#SOHUCS" itemprop="discussionUrl">
                  <span id="changyan_count_unit" class="post-comments-count hc-comment-count" data-xid="2020/03/30/（url中显示的标题）/" itemprop="commentsCount"></span>
                </a>
              
            
          

          
          
             <span id="/2020/03/30/（url中显示的标题）/" class="leancloud_visitors" data-flag-title="我的音视频技术路线">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          

          

        </span></div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        <p>​    抖音/快手等短视频APP的风靡，让音视频成为当下最火热的技术，越来越多的人想要进入到这个领域，我自己也是从图形方向刚刚踏入这领域不久，音视频方向所包含的技术栈非常复杂，我自己也在一点一点慢慢钻研，这里面每一个方向都值得深入研究，而且随着5G时代的到来，音视频方向的应用会更加广泛，所以希望自己能掌握更多的关于音视频方向的技能，未来可以探索更多的音视频玩法。然后这篇博客主要是想梳理一下我自己关于音视频这个方向的学习路线，分享出来的同时也能鼓励自己朝着这个方向继续深耕下去。</p>
<p>​    关于音视频方向的基础技能分支，先来看一张图（图片来自网上）</p>
<p><img src="https://i.loli.net/2020/03/30/XOIjb1L9vAak2Zs.jpg" alt="basic.jpg"></p>
<p>采集：音视频数据来源，比如Android Camera数据采集</p>
<p>渲染：将采集得到的数据展示到Surface上，并添加一些图形效果</p>
<p>处理：对源数据的加工，比如添加滤镜、特效，还有多视频剪辑、变速、转场等等</p>
<p>编解码：对音视频数据进行压缩封装，减少数据量，方便传输</p>
<p>传输：对采集加工完成的数据传输至客户端，比如直播推流、拉流</p>
<a id="more"></a>
<h3 id="1-关于音视频数据采集-Android"><a href="#1-关于音视频数据采集-Android" class="headerlink" title="1. 关于音视频数据采集(Android)"></a>1. 关于音视频数据采集(Android)</h3><p>​    因为自己主要是对Android Camera比较熟悉，所以我主要梳理一下这方面的知识点，我会从最基础的Android Camera API的接口以及基本流程开始梳理，后面进阶部分主要是结合Camera HAL高通架构进一步详细梳理底层的Camera原理，最后是我对于Camera专业视频方向的一些探索。</p>
<h4 id="1-1-Android-Camera-API"><a href="#1-1-Android-Camera-API" class="headerlink" title="1.1 Android Camera API"></a>1.1 Android Camera API</h4><p>​      Android 5.0之后Camera接口升级成API2，因为Camera API 1接口过于简单，根本体现不出硬件能力，用户能控制的不多，比如拿不到RAW数据，控制不了相机参数的下发等等，如下代码看下他内部的基本接口</p>
<p>​    Camera API 1</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">            mCamera = Camera.open(mCurrentCamera);</span><br><span class="line">            Camera.Parameters params = mCamera.getParameters();</span><br><span class="line">            List&lt;Camera.Size&gt; previewSizes = params.getSupportedPreviewSizes();</span><br><span class="line"></span><br><span class="line">            Camera.Size preViewSize = previewSizes.get(previewSizes.size() &gt; <span class="number">4</span> ? previewSizes.size() - <span class="number">4</span> : <span class="number">0</span>);</span><br><span class="line">            params.setPreviewSize(preViewSize.width, preViewSize.height);</span><br><span class="line">            mPreviewHeight = preViewSize.height;</span><br><span class="line">            mPreviewWidth = preViewSize.width;</span><br><span class="line">            Log.e(TAG, <span class="string">"preViewSize-&gt;width: "</span> + preViewSize.width + <span class="string">", preViewSize-&gt;height: "</span> + preViewSize.height);</span><br><span class="line"></span><br><span class="line">            params.setPictureFormat(ImageFormat.JPEG);</span><br><span class="line">            params.setJpegQuality(<span class="number">100</span>);</span><br><span class="line">            <span class="comment">//是否开启闪光</span></span><br><span class="line">            List&lt;String&gt; flashModes = params.getSupportedFlashModes();</span><br><span class="line">            <span class="keyword">if</span> (flashModes != <span class="keyword">null</span> &amp;&amp; flashModes.contains(Camera.Parameters.FLASH_MODE_OFF)) &#123;</span><br><span class="line">                params.setFlashMode(Camera.Parameters.FLASH_MODE_OFF);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mCamera.setPreviewCallback(<span class="keyword">this</span>);</span><br><span class="line">            mCamera.setDisplayOrientation(PORTRAIT_MODE);</span><br><span class="line">            mCamera.setParameters(params);</span><br><span class="line">            <span class="keyword">if</span>(!Consts.SHOW_CAMERA) &#123;</span><br><span class="line">                LogUtils.log_main_step(<span class="string">"相机开始preview"</span>);</span><br><span class="line">                mCamera.startPreview();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            LogUtils.logd(TAG, <span class="string">"camera init finish....."</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LogUtils.loge(TAG, e.getMessage());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>然后在CameraPreview callback里面就可以处理相机数据了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPreviewFrame</span><span class="params">(<span class="keyword">byte</span>[] data, Camera camera)</span> </span>&#123;</span><br><span class="line">        Camera.CameraInfo mCameraInfo = <span class="keyword">new</span> Camera.CameraInfo();</span><br><span class="line">        <span class="comment">//如果使用前置摄像头，请注意显示的图像与帧图像左右对称，需处理坐标</span></span><br><span class="line">        <span class="keyword">boolean</span> frontCamera = (mCurrentCamera == Camera.CameraInfo.CAMERA_FACING_FRONT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取重力传感器返回的方向</span></span><br><span class="line">        <span class="keyword">int</span> dir = getDirection();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> rotate = (dir ^ <span class="number">1</span>);</span><br><span class="line">        <span class="comment">//Log.e("stRotateCamera  ", (dir ^ 1) + " rotate result");</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//在使用后置摄像头，且传感器方向为0或2时，后置摄像头与前置orentation相反</span></span><br><span class="line">        <span class="keyword">if</span> (!frontCamera &amp;&amp; dir == <span class="number">0</span>) &#123;</span><br><span class="line">            dir = <span class="number">2</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!frontCamera &amp;&amp; dir == <span class="number">2</span>) &#123;</span><br><span class="line">            dir = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        dir = (dir ^ <span class="number">2</span>);</span><br><span class="line">      	<span class="comment">//.....</span></span><br><span class="line">      	process(data)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><a href="http://graphics.stanford.edu/projects/camera-2.0/" target="_blank" rel="noopener">    关于Camera2的介绍</a></p>
<blockquote>
<p>Camera 2.0: New computing platforms for computational photography</p>
</blockquote>
<p>​    Camera API2对比API 1改动非常大，主要配合HAL3进行使用，功能和接口都更加齐全，同时使用起来也会更加复杂，但如果熟悉之后，也能拍摄出更加丰富的效果。下图关于Camera API 2的几个使用场景</p>
<p><img src="https://i.loli.net/2020/03/30/YwbtVpLrKUPCX97.png" alt="camera_api2.png"></p>
<p>​    然后结合具体代码讲几个Camera2的主要接口</p>
<p><strong>1.CameraManager</strong></p>
<p>关于硬件能力的统一封装接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CameraManager cameraManager = (CameraManager)mContext.getSystemService(Context.CAMERA_SERVICE);</span><br><span class="line"><span class="comment">//可以拿到所以的相机列表，比如Wide，Tele，Macro，Tele2x，Tele4x等等</span></span><br><span class="line">String[] cameraIdList = cameraManager.getCameraIdList();</span><br><span class="line"><span class="comment">//根据Camera ID拿到对应设备支持的能力</span></span><br><span class="line">CameraCharacteristics cameraCharacteristics =</span><br><span class="line">  cameraManager.getCameraCharacteristics(cameraIdStr);</span><br><span class="line"><span class="comment">//比如用这个去判断支持的最小Focus distance</span></span><br><span class="line">Float focusDistance = mCharacteristics.get(CameraCharacteristics.LENS_INFO_MINIMUM_FOCUS_DISTANCE);</span><br></pre></td></tr></table></figure>
<p>​    现如今机型的摄像头的数量越来越多，组合也越来越丰富，不同的Camera负责不同的能力，比如我们需要更大的拍摄范围会选择Ultra Wide，比如小米一亿像素的Wide，还有Macro等等。</p>
<p><strong>2.CaptureDevice</strong></p>
<p>我们可以在OpenCamera Callback拿到CameraDevice</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">String cameraIdStr = String.valueOf(mCameraId);</span><br><span class="line">            cameraManager.openCamera(cameraIdStr, mCameraStateCallback, mMainHandler);</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">private</span> CameraDevice.StateCallback mCameraStateCallback = <span class="keyword">new</span> CameraDevice.StateCallback() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onOpened</span><span class="params">(@NonNull CameraDevice camera)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (SnapCamera.<span class="keyword">this</span>) &#123;</span><br><span class="line">                mCameraDevice = camera;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mStatusListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mStatusListener.onCameraOpened();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDisconnected</span><span class="params">(@NonNull CameraDevice camera)</span> </span>&#123;</span><br><span class="line">            Log.w(TAG, <span class="string">"onDisconnected"</span>);</span><br><span class="line">            <span class="comment">// fail-safe: make sure resources get released</span></span><br><span class="line">            release();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(@NonNull CameraDevice camera, <span class="keyword">int</span> error)</span> </span>&#123;</span><br><span class="line">            Log.e(TAG, <span class="string">"onError: "</span> + error);</span><br><span class="line">            <span class="comment">// fail-safe: make sure resources get released</span></span><br><span class="line">            release();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>
<p>3.<strong>CaptureRequest</strong></p>
<p>​       通过CameraDevice可以创建CaptureRequest，类型主要有以下几种，1-6分布用于预览、拍照、录制、录制中拍照、ZSL、手动。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TEMPLATE_MANUAL = <span class="number">6</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TEMPLATE_PREVIEW = <span class="number">1</span>; </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TEMPLATE_RECORD = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TEMPLATE_STILL_CAPTURE = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TEMPLATE_VIDEO_SNAPSHOT = <span class="number">4</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TEMPLATE_ZERO_SHUTTER_LAG = <span class="number">5</span>;</span><br><span class="line"><span class="comment">//创建的代码</span></span><br><span class="line">mPreviewRequestBuilder = mCameraDevice.createCaptureRequest(CameraDevice.TEMPLATE_PREVIEW);</span><br><span class="line"></span><br><span class="line"><span class="comment">//这里是更加专业一点的用法，可以不看，就是拿到RequestBuilder之后我们可以去下发各种TAG，如下设置AE/AWB锁</span></span><br><span class="line">CaptureRequestBuilder.applyAELock(request, mConfigs.isAELocked());</span><br><span class="line">CaptureRequestBuilder.applyAWBLock(request, mConfigs.isAWBLocked());</span><br></pre></td></tr></table></figure>
<p>4.<strong>Surface</strong></p>
<p>Surface主要是用来接相机返回的数据，可以支持不同的数据类型和分辨率</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SurfaceTexture的方式，用于预览</span></span><br><span class="line">mSurfaceTexture = <span class="keyword">new</span> SurfaceTexture(<span class="keyword">false</span>);</span><br><span class="line">mSurfaceTexture.setDefaultBufferSize(optimalSize.width, optimalSize.height);</span><br><span class="line">mPreviewSurface = <span class="keyword">new</span> Surface(mSurfaceTexture);</span><br><span class="line"><span class="comment">//ImageReader 的方式, Format可以是YUV、RAW，DEPTH等</span></span><br><span class="line">mPhotoImageReader = ImageReader.newInstance(size.getWidth(), size.getHeight(),</span><br><span class="line">                ImageFormat.JPEG, <span class="comment">/* maxImages */</span> <span class="number">2</span>);</span><br><span class="line">mPhotoImageReader.setOnImageAvailableListener(mPhotoAvailableListener, mCameraHandler);</span><br><span class="line"><span class="comment">//创建session</span></span><br><span class="line">List&lt;Surface&gt; surfaces = Arrays.asList(mPreviewSurface, mPhotoImageReader.getSurface());</span><br><span class="line">mCameraDevice.createCaptureSession(surfaces, mSessionCallback, mCameraHandler);</span><br></pre></td></tr></table></figure>
<p>5.<strong>CaptureSession</strong></p>
<p>通过上面的CameraDevice创建Session，在Callback里面拿到Session</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">mCameraDevice.createCaptureSession(surfaces, mSessionCallback, mCameraHandler);</span><br><span class="line"><span class="keyword">private</span> CameraCaptureSession.StateCallback</span><br><span class="line">            mSessionCallback = <span class="keyword">new</span> CameraCaptureSession.StateCallback() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onConfigured</span><span class="params">(@NonNull CameraCaptureSession session)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (SnapCamera.<span class="keyword">this</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mCameraDevice == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Log.e(TAG, <span class="string">"onConfigured: CameraDevice was already closed."</span>);</span><br><span class="line">                    session.close();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                mCaptureSession = session;</span><br><span class="line">            &#125;</span><br><span class="line">            startPreview();</span><br><span class="line">            capture();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onConfigureFailed</span><span class="params">(@NonNull CameraCaptureSession session)</span> </span>&#123;</span><br><span class="line">            Log.e(TAG, <span class="string">"sessionCb: onConfigureFailed"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>
<p>​    后面所有的采集工作都是基于Session，关于Session机制最早是诺基亚提出来的，后面苹果的IOS也采取Session作为相机拍照，录制的会话单元。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*发起请求，后续相机开始往surface输出数据，这个可以在onConfigured里面调用，如上面的代码       		    startPreview();</span></span><br><span class="line"><span class="comment">capture();*/</span></span><br><span class="line">mCaptureSession.setRepeatingRequest(mPreviewRequestBuilder.build(),</span><br><span class="line">                    mCaptureCallback, mCameraHandler);</span><br><span class="line">mCaptureSession.capture(requestBuilder.build(), mCaptureCallback, mCameraHandler);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这个是针对120/240/960Fps recording</span></span><br><span class="line">mCaptureSession.setRepeatingBurst(requestList, mCaptureCallback, mCameraHandler);</span><br><span class="line">mCaptureSession.captureBurst(requestList, listener, handler);</span><br></pre></td></tr></table></figure>
<p>然后还可以通过Session控制结束动作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mCaptureSession.abortCaptures();</span><br><span class="line">mCaptureSession.stopRepeating();</span><br></pre></td></tr></table></figure>
<p>​    对象更加专业一点的系统相机而言，在setRepeatingRequest之前可以还需要做很多工作，比如拍照要等Focus finish，还需要Apply一些列参数，比如FocusMode, Zoom, AE/F Lock, Video FPS…..</p>
<p>总结：上面只是一个大概流程，至于每个流程你需要去控制什么可能就会更加复杂，但其实对于第三方APP，需要控制的不多，基本就是OpenCamera -&gt; 配置Surface -&gt; 创建Session -&gt; 设置参数 -&gt; RepeatingRequest -&gt;ImageReader或者GLSurafce回调接数据做后续处理。可能有些更加专业一点的相机应用，可能会涉及的一些专业参数的下发，比如IOS, FocusDistance, Shutter Time, EV….</p>
<h4 id="1-2-Camera-HAL"><a href="#1-2-Camera-HAL" class="headerlink" title="1.2 Camera HAL"></a>1.2 Camera HAL</h4><blockquote>
<p>Android Camera硬件抽象层（HAL，Hardware Abstraction Layer）主要用于把底层camera drive与硬件和位于android.hardware中的framework APIs连接起来。Camera子系统主要包含了camera pipeline components 的各种实现，而camera HAL提供了这些组件的使用接口</p>
</blockquote>
<p>官网的系统架构图：</p>
<p><img src="https://i.loli.net/2020/03/30/xBLf8olEGuO3FAq.png" alt="camera_hal.png"></p>
<p>​    做相机开发除了第一部分讲到的APP层面的相机控制，然后就是HAL层的开发了，HAL层由芯片厂商定制(比如高通等),手机厂商可以再其上增加一些内容。Camera HAL 经历1-3的版本迭代，不同的硬件支持的Camera2程度不一样，主要有以下等级</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//每一个等级啥意思自己搜吧</span></span><br><span class="line">INFO_SUPPORTED_HARDWARE_LEVEL_LEGACY</span><br><span class="line">INFO_SUPPORTED_HARDWARE_LEVEL_LIMITED</span><br><span class="line">INFO_SUPPORTED_HARDWARE_LEVEL_FULL</span><br><span class="line">INFO_SUPPORTED_HARDWARE_LEVEL_3</span><br><span class="line">INFO_SUPPORTED_HARDWARE_LEVEL_EXTERNAL</span><br></pre></td></tr></table></figure>
<p> 想了一下这一块比较复杂，我自己也不是非常的清楚，而且好像第三方APP一般不会涉及，后面有机会单独整理吧(挖坑1)</p>
<h4 id="1-3-CameraX"><a href="#1-3-CameraX" class="headerlink" title="1.3 CameraX"></a>1.3 CameraX</h4><p>​    如上看到的Camera API2非常复杂，为了简化流程，Google推出CameraX，借助 CameraX，开发者只需两行代码就能利用与预安装的相机应用相同的相机体验和功能。 CameraX Extensions 是可选插件，通过该插件，您可以在支持的设备上向自己的应用中添加人像、HDR、夜间模式和美颜等效果。如下预览和拍照的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//预览</span></span><br><span class="line">PreviewConfig config = <span class="keyword">new</span> PreviewConfig.Builder().build();</span><br><span class="line">Preview preview = <span class="keyword">new</span> Preview(config);</span><br><span class="line"></span><br><span class="line"> preview.setOnPreviewOutputUpdateListener(</span><br><span class="line">     <span class="keyword">new</span> Preview.OnPreviewOutputUpdateListener() &#123;</span><br><span class="line">         <span class="meta">@Override</span></span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onUpdated</span><span class="params">(Preview.PreviewOutput previewOutput)</span> </span>&#123;</span><br><span class="line">             <span class="comment">// Your code here. For example, use previewOutput.getSurfaceTexture()</span></span><br><span class="line">             <span class="comment">// and post to a GL renderer.</span></span><br><span class="line">         &#125;;</span><br><span class="line"> &#125;);</span><br><span class="line"></span><br><span class="line"> CameraX.bindToLifecycle((LifecycleOwner) <span class="keyword">this</span>, preview);</span><br><span class="line"></span><br><span class="line"><span class="comment">//拍照</span></span><br><span class="line">ImageCaptureConfig config =</span><br><span class="line"><span class="keyword">new</span> ImageCaptureConfig.Builder()</span><br><span class="line">        .setTargetRotation(getWindowManager().getDefaultDisplay().getRotation())</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">ImagesCapture imageCapture = <span class="keyword">new</span> ImageCapture(config);</span><br><span class="line">CameraX.bindToLifecycle((LifecycleOwner) <span class="keyword">this</span>, imageCapture, imageAnalysis, preview);</span><br><span class="line"></span><br><span class="line">ImageCapture.Metadata metadata = <span class="keyword">new</span> ImageCapture.Metadata();</span><br><span class="line">        metadata.isReversedHorizontal = mCameraLensFacing == LensFacing.FRONT;</span><br><span class="line">imageCapture .takePicture(saveLocation, metadata, executor, OnImageSavedListener);</span><br></pre></td></tr></table></figure>
<h4 id="1-4-Camera专业视频-进阶"><a href="#1-4-Camera专业视频-进阶" class="headerlink" title="1.4 Camera专业视频(进阶)"></a>1.4 Camera专业视频(进阶)</h4><p>​    现如今手机相机功能越来越强大，现在已经基本可以取代卡片机，手机相机已经作为手机厂商最重要的一个卖点，尤其是DXO刷榜的行为，之后让厂商投入更多的研发相机上面，在可以预见的未来，手机相机发展势必会更加激进，后面进一步取代部分单反也是有可能的，所以相机未来应该更多的体现起作为生产力工具的一部分，尤其是现在视频作为人们记录生活的方式，越来越得到普及。</p>
<p>​    如果说到视频和相机，我的想法是如何去拍摄更加专业的视频，借助手机相机强大的功能，能否让一部分专业人士用他作为生产力工具，部分取代非常不便携的单反设备，比如借助Camera2参数调节功能去实现长曝光、延时、流光快门等效果。</p>
<p>​    相机更加专业的方向，主要体现手机厂商的系统相机，尤其是Android端，很多硬件能力只能由手机厂商自己控制，比如系统相机里面的专业模式，还有就是类似大疆这种，也是自己做相机硬件，然后能够结合硬件能力，去实现一些更加专业的拍摄效果。目前软件这块做的比较专业的就是<a href="https://www.filmicpro.com/" target="_blank" rel="noopener">Fimic Pro</a>。</p>
<p><img src="https://i.loli.net/2020/03/30/QrSPgaK8Y1N6VUL.png" alt="filmic.png"></p>
<p>​    </p>
<p>​    支持各种调参：ISO ，Exposure time，WB，EV，Focus distance</p>
<p>​    支持平滑变焦，光焦分离</p>
<p>​    支持曲线调整：亮度、饱和度、阴影、Gamma曲线等</p>
<p>​    支持LOG格式，还有专业的音频采集</p>
<p>​    有非常多的辅助信息，比如峰值对焦、曝光反馈、RGB直方图信息等</p>
<p>​    音视频各种格式自定义：画幅比例、FPS、分辨率、音频采样率、编码格式等等</p>
<p>​    </p>
<p>真的是一个非常强大的生产力工具</p>
<h3 id="2-关于图形渲染"><a href="#2-关于图形渲染" class="headerlink" title="2. 关于图形渲染"></a>2. 关于图形渲染</h3><p>​    音视频第二部分肯定是图形渲染方向啦，因为之前一直有做图形渲染方面的工作，也写过自己的渲染引擎，链接如下</p>
<p>​    <a href="https://github.com/LukiYLS/SimpleRenderer" target="_blank" rel="noopener">https://github.com/LukiYLS/SimpleRenderer</a></p>
<p>以及关于这个引擎的介绍</p>
<p>​    <a href="http://yanglusheng.com/" target="_blank" rel="noopener">http://yanglusheng.com/</a></p>
<p>​    所以可以大概分享一下自己的学习过程，以及关于Android GLES相关总结</p>
<h4 id="2-1-图形学基础"><a href="#2-1-图形学基础" class="headerlink" title="2.1 图形学基础"></a>2.1 图形学基础</h4><p>​    我觉图形方面基础的应该需要掌握如下：</p>
<p>1.<strong>整个图形矩阵变换过程</strong></p>
<p>World Matrix：将场景中所有对象统一到一个坐标系下</p>
<p>ViewMatrix：World Matrix 变换的相机坐标系，根据相机的三个参数生成</p>
<p>ProjectionMatrix：3D世界投影的2D平面</p>
<p>NDC：转换到[-1 1]</p>
<p>Screen Matrix：转换的屏幕坐标系</p>
<p>这部分想要理解就要自己用笔手推一遍，非常管用</p>
<p>2.<strong>OpenGL API</strong></p>
<p>熟悉API，比如纹理贴图方式，绘制点线面，VAO/VBO创建等等</p>
<p>3.<strong>光照</strong></p>
<p>首先需要理解传统的Phong光照，然后要看PBR，理解BRDF模型和公式推导</p>
<p>还有就是Shadow这快，理解shadowmap的原理，不同的光照怎样生成深度图，然后shadow acne，处理边缘锯齿等很多细节，还有阴影体这块</p>
<p>4.<strong>模版测试/深度测试</strong></p>
<p>深度测试实现遮挡</p>
<p>模版测试也是非常有用，比如我有篇博客里面讲到的 阴影体结合模版测试实现矢量紧贴地形的效果</p>
<p>5.<strong>地形</strong></p>
<p>怎用利用perlin noise生成地形顶点数据</p>
<p>LOD的地形：规则四叉树划分(Google Earth地形)，以及不规则的CLOD(自适应三角网)</p>
<p>6.<strong>粒子系统</strong></p>
<p>主要就是怎么控制粒子发射器，粒子加速的，粒子运动轨迹等等</p>
<p>7.<strong>场景管理</strong></p>
<p>如何利用四叉树、八叉树管理场景节点，做视锥体裁剪</p>
<p>……..</p>
<p>//之前写的earth平台，包括八叉树管理全球数据的想法</p>
<p><img src="https://i.loli.net/2020/03/30/4tjRNxuId9657Ma.png" alt="global_earth.png"></p>
<p><strong>总结：</strong></p>
<p>学习图形学最好的方式就是造轮子造轮子造轮子，自己写引擎，自己写软光栅器</p>
<p>学习资料分享：</p>
<p><a href="https://learnopengl-cn.github.io/" target="_blank" rel="noopener">https://learnopengl-cn.github.io/</a></p>
<p><a href="https://www.scratchapixel.com/" target="_blank" rel="noopener">https://www.scratchapixel.com/</a></p>
<p>阅读源码：OGRE/OSG/THREEJS</p>
<p>工具: unity3d processing</p>
<h4 id="2-2-OpenGL-GLES"><a href="#2-2-OpenGL-GLES" class="headerlink" title="2.2 OpenGL/GLES"></a>2.2 OpenGL/GLES</h4><p><strong>1.EGL环境创建</strong></p>
<p>   eglGetDisplay //获取display信息</p>
<p>   eglChooseConfig //设置RGBA bit depth</p>
<p>   eglCreatePbufferSurface // 创建离屏surface, 也可以eglCreateWindowSurface</p>
<p>   eglCreateContext //创建上下文</p>
<p><strong>2.GL多线程</strong></p>
<ul>
<li><p>SharedContext多线程</p>
<p>这个网上也有很多资料，eglCreateContext 的时候传入其它线程的Context，既可以共享一些GPU Buffer，比如：MediaCodec录制的用的Surface，和预览去sharedContext</p>
</li>
<li><p>Render pass如何做同步glFenceSync</p>
<p>如果用glFinish可能会在某个点等的时间很长，可以用glFenceSync做同步，非常不错</p>
</li>
</ul>
<p><strong>3.渲染优化</strong></p>
<p>​        帧率如何优化，涉及到很多方面，这方面游戏引擎有很多技巧，比如提前视锥体裁剪，遮挡剔除等等，我这里只是简单讲一下在不涉及到大场景的优化有哪些</p>
<p>个人关于效率优化的总结：</p>
<p>​    尽量在渲染之前先做视锥体裁剪工作，减少不必要的IO</p>
<p>​    尽量少使用一些同步阻塞操作，比如glReadPixel、glFinish、glTeximage2D等</p>
<p>​    Shader里面少使用if/for这种操作</p>
<p>​    必要时做下采样</p>
<p>​    利用好内存对齐，会有意想不到的效率提升</p>
<p>​    渲染之前做好一些列准备工作，比如编译Shader</p>
<h4 id="2-3-音视频渲染引擎-扒抖音"><a href="#2-3-音视频渲染引擎-扒抖音" class="headerlink" title="2.3 音视频渲染引擎(扒抖音)"></a>2.3 音视频渲染引擎(扒抖音)</h4><p>​    现在短视频应用关于特效部分底层都有会有一套渲染引擎，不管的抖音还是快手，你把抖音的的APP package pull出来就能看到，里面是同lua脚本去调用底层的渲染引擎，lua脚本负责下发一些参数，主要是AI的一些识别结果以及用户的交互事件。</p>
<p>​    虽然没有游戏引擎那么强大，但基本模块应该都会包含模型、资源管理、相机控制、裁剪、渲染等等，毕竟写这套引擎的基本都是以前搞游戏的那拨人，算是降维来写音视频渲染引擎。</p>
<p>​    下面通过拆解抖音内部的资源文件，探究内部关于音视频渲染引擎的模块组成，对比短视频引擎和游戏引擎的区别。</p>
<p> 一起来看看抖音最近很火的一个游戏：潜水艇，通过移动鼻子控制潜水艇</p>
<p><img src="https://i.loli.net/2020/03/30/lXpri2536NO7cmI.png" alt="tiktok_demo.png" style="zoom:50%;"></p>
<p>如下是download 的资源包</p>
<p><img src="https://i.loli.net/2020/03/30/a8FhiQmOTnA5Lzk.png" alt="tiktok_effect1.png"></p>
<p>​    这里面的核心控制逻辑就是那个lua基本，里面会负责把人脸关键点信息传给底层引擎，实时更新潜水艇的位置，脚本实现了两个碰撞检测函数，用于潜水艇和柱子之间做碰撞检测。Collision玩过游戏引擎的都很熟悉，有些游戏引擎Collision detect做的不好的会出现穿模的现象。</p>
<p>​    rectCollision: 潜水艇中心坐标和柱子底部坐标之间的距离，与潜水艇半径比较，小于0.9*R，就是碰撞了</p>
<p>​    circleCollision:  两个圆心坐标之间的距离和他们各自半径之和比较，小于半径和，就是碰撞了</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">local intpx = <span class="number">220</span>      --柱子左右间隔</span><br><span class="line">local intpy = <span class="number">550</span>      --柱子中间缝隙宽度</span><br><span class="line">local range_y = &#123;<span class="number">0.3</span>, <span class="number">0.7</span>&#125;      --柱子缝隙中央随机范围，&#123;<span class="number">0.3</span>,<span class="number">0.7</span>&#125;代表缝隙可能在屏幕高度<span class="number">30</span>%<span class="number">-70</span>%的位置随机出现</span><br><span class="line">local sp = &#123;<span class="number">0.5</span>,<span class="number">1.0</span>&#125;         --速度初始和最终速度，&#123;<span class="number">0.5</span>,<span class="number">1.0</span>&#125;代表初始速度为<span class="number">1</span>秒走过<span class="number">0.5</span>个屏幕，最终速度为<span class="number">1</span>秒走过<span class="number">1</span>个屏幕</span><br><span class="line">local ptime = <span class="number">3</span>           --准备时间<span class="number">3</span>s</span><br><span class="line">local range_s = &#123;<span class="number">5</span>,<span class="number">10</span>&#125;  --分数分段，&#123;<span class="number">5</span>,<span class="number">10</span>&#125;代表<span class="number">0</span><span class="number">-5</span>第一段，<span class="number">6</span><span class="number">-10</span>第二段，<span class="number">10</span>以上第三段；<span class="number">10</span>以上未碰撞第四段</span><br><span class="line">local smul = <span class="number">0.8</span>        --字号倍率</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//.....此次省略N行</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//两个碰撞检测函数</span></span><br><span class="line"><span class="comment">//u=1,2 代码上面和下面柱子</span></span><br><span class="line">local function rectCollision(i,u)</span><br><span class="line">    local K_s_x = sub.x</span><br><span class="line">    local K_s_y = sub.y * ratio</span><br><span class="line">    local K_rect_x = pillar[i].x</span><br><span class="line">    local K_rect_y = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    local l = K_rect_x - r </span><br><span class="line">    local r = K_rect_x + r </span><br><span class="line">    local t = <span class="number">0</span></span><br><span class="line">    local b = <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> u == <span class="number">1</span> then</span><br><span class="line">        t = <span class="number">-1</span></span><br><span class="line">        b = (pillar[i].y - interval_y / <span class="number">2</span>) * ratio</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        t = (pillar[i].y + interval_y / <span class="number">2</span>) * ratio</span><br><span class="line">        b = <span class="number">2</span></span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    local closestP_x = <span class="number">0.0</span></span><br><span class="line">    local closestP_y = <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">    closestP_x = clamp(K_s_x, l , r)</span><br><span class="line">    closestP_y = clamp(K_s_y, t , b)</span><br><span class="line">    local dist = distance(closestP_x, closestP_y, K_s_x, K_s_y)</span><br><span class="line">    <span class="keyword">if</span> dist &lt;= sub.r * <span class="number">0.9</span> then </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    end</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">local function circleCollision(i,u)</span><br><span class="line">    local K_s_x = sub.x</span><br><span class="line">    local K_s_y = sub.y * ratio</span><br><span class="line">    local K_cir_x = pillar[i].x</span><br><span class="line">    local K_cir_y = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> u == <span class="number">1</span> then</span><br><span class="line">        K_cir_y = (pillar[i].y - interval_y / <span class="number">2</span>) * ratio</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        K_cir_y = (pillar[i].y + interval_y / <span class="number">2</span>) * ratio</span><br><span class="line">    end</span><br><span class="line">    local dist = distance(K_cir_x, K_cir_y, K_s_x, K_s_y)</span><br><span class="line">    <span class="keyword">if</span> dist &lt;= sub.r * <span class="number">0.9</span> + r then </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    end</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>还有两个重要的函数，分别处理预览和录制，游戏过程的逻辑，比如柱子随着时间线一直在移动，speed在加快</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line">handleTimerEvent = function(<span class="keyword">this</span>, timerId, milliSeconds)</span><br><span class="line">        <span class="keyword">if</span> timerId == timer_ID_Fast <span class="keyword">and</span> gaming then</span><br><span class="line">            <span class="keyword">if</span> init_state ~= <span class="number">0</span> then</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">            end</span><br><span class="line"></span><br><span class="line">            timeThis = getTime(<span class="keyword">this</span>)</span><br><span class="line">            timeDelta = getDiffTime(timeLast, timeThis)</span><br><span class="line">            timeCumu = timeCumu + timeDelta</span><br><span class="line">            timeLast = timeThis</span><br><span class="line">            </span><br><span class="line">            local speed = sp[<span class="number">1</span>] + clamp(timeCumu / <span class="number">14</span>, <span class="number">0</span>,<span class="number">1</span>) * (sp[<span class="number">2</span>] - sp[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> timeCumu &gt; <span class="number">14</span> then</span><br><span class="line">                gaming = <span class="literal">false</span></span><br><span class="line">                Sticker2DV3.playClip(<span class="keyword">this</span>, feature_0.folder, feature_0.entity[<span class="number">1</span>], feature_0.clip[<span class="number">1</span>], <span class="number">0</span>)</span><br><span class="line">                </span><br><span class="line">                CommonFunc.setFeatureEnabled(<span class="keyword">this</span>, <span class="keyword">feature_t</span>.folder, <span class="literal">true</span>)</span><br><span class="line">                <span class="keyword">if</span> score &gt;= <span class="number">10</span> then</span><br><span class="line">                    realTimeFunc.initRealTime(<span class="keyword">this</span>, <span class="keyword">feature_t</span>.folder, <span class="literal">true</span>, <span class="keyword">feature_t</span>.realTimeParams[<span class="number">1</span>])</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    realTimeFunc.initRealTime(<span class="keyword">this</span>, <span class="keyword">feature_t</span>.folder, <span class="literal">true</span>, <span class="keyword">feature_t</span>.realTimeParams[<span class="number">2</span>])</span><br><span class="line">                end</span><br><span class="line">                realTimeFunc.setRealTime(<span class="keyword">this</span>, <span class="keyword">feature_t</span>.folder, <span class="string">"u_data"</span>, score)</span><br><span class="line">                </span><br><span class="line">            end</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> i = <span class="number">1</span>,<span class="number">5</span> <span class="keyword">do</span></span><br><span class="line">                pillar[i].x = pillar[i].x - speed * timeDelta</span><br><span class="line">                <span class="keyword">if</span> pillar[i].x &lt; -r then</span><br><span class="line">                    pillar[i].x = pillar[i].x + interval_x * <span class="number">5</span></span><br><span class="line">                    pillar[i].y = range_y[<span class="number">1</span>] + math.random() * (range_y[<span class="number">2</span>] - range_y[<span class="number">1</span>])</span><br><span class="line">                    pillar[i].counted = <span class="literal">false</span></span><br><span class="line">                end</span><br><span class="line">                <span class="keyword">if</span> pillar[i].x &lt; sub.x <span class="keyword">and</span> <span class="keyword">not</span> pillar[i].counted then</span><br><span class="line">                    pillar[i].counted = <span class="literal">true</span></span><br><span class="line">                    score = score + <span class="number">1</span></span><br><span class="line">                    </span><br><span class="line">                end</span><br><span class="line"></span><br><span class="line">                local cy = pillar[i].y - (interval_y / <span class="number">2</span> - r / ratio) - <span class="number">0.5</span></span><br><span class="line">                local cx = pillar[i].x</span><br><span class="line">                set4Vtx(<span class="keyword">this</span>, feature_3.folder, feature_3.entity[<span class="number">1</span>], feature_3.clip[<span class="number">2</span>*i<span class="number">-1</span>], cx , cy, <span class="number">2</span> * r, <span class="number">1.0</span> , <span class="number">0.0</span>, <span class="number">1.0</span>, ratio, <span class="number">0.0</span>, <span class="number">0.0</span>)</span><br><span class="line"></span><br><span class="line">                cy = pillar[i].y + (interval_y / <span class="number">2</span> - r / ratio) + <span class="number">0.5</span></span><br><span class="line">                <span class="comment">//更新实体坐标</span></span><br><span class="line">                set4Vtx(<span class="keyword">this</span>, feature_3.folder, feature_3.entity[<span class="number">1</span>], feature_3.clip[<span class="number">2</span>*i], cx , cy, <span class="number">2</span> * r, <span class="number">1.0</span> , <span class="number">0.0</span>, <span class="number">1.0</span>, ratio, <span class="number">0.0</span>, <span class="number">0.0</span>)</span><br><span class="line">            end</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> noseY ~= <span class="number">0</span> then</span><br><span class="line">                sub.y = noseY</span><br><span class="line">            end</span><br><span class="line">            <span class="keyword">if</span> (sub.y ~= <span class="number">0</span> <span class="keyword">or</span> lastY ~= <span class="number">0</span>) then</span><br><span class="line">                sub.a = sub.a * <span class="number">0.8</span> + (sub.y - lastY) / timeDelta * <span class="number">0.2</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                sub.a = sub.a * <span class="number">0.8</span></span><br><span class="line">            end</span><br><span class="line"></span><br><span class="line">            set4Vtx(<span class="keyword">this</span>, feature_2.folder, feature_2.entity[<span class="number">1</span>], feature_2.clip[<span class="number">1</span>], sub.x , sub.y, <span class="number">2</span> * sub.r, <span class="number">2</span> * sub.r / ratio / <span class="number">1.1</span> , sub.a, <span class="number">1.0</span>, ratio, <span class="number">0.0</span>, <span class="number">0.0</span>)</span><br><span class="line"></span><br><span class="line">						<span class="comment">//对所有柱子遍历做碰撞检测</span></span><br><span class="line">            <span class="keyword">for</span> i = <span class="number">1</span>,<span class="number">5</span> <span class="keyword">do</span></span><br><span class="line">                <span class="keyword">if</span> rectCollision(i,<span class="number">1</span>) <span class="keyword">or</span> rectCollision(i,<span class="number">2</span>) <span class="keyword">or</span> circleCollision(i,<span class="number">1</span>) <span class="keyword">or</span> circleCollision(i,<span class="number">2</span>) then</span><br><span class="line"></span><br><span class="line">                    gaming = <span class="literal">false</span></span><br><span class="line">                    <span class="keyword">if</span> score &lt;= range_s[<span class="number">1</span>] then</span><br><span class="line">                        Sticker2DV3.playClip(<span class="keyword">this</span>, feature_0.folder, feature_0.entity[<span class="number">1</span>], feature_0.clip[<span class="number">4</span>], <span class="number">0</span>)</span><br><span class="line">                    elseif score &lt;= range_s[<span class="number">2</span>] then</span><br><span class="line">                        Sticker2DV3.playClip(<span class="keyword">this</span>, feature_0.folder, feature_0.entity[<span class="number">1</span>], feature_0.clip[<span class="number">3</span>], <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        Sticker2DV3.playClip(<span class="keyword">this</span>, feature_0.folder, feature_0.entity[<span class="number">1</span>], feature_0.clip[<span class="number">2</span>], <span class="number">0</span>)</span><br><span class="line">                    end</span><br><span class="line"></span><br><span class="line">                    CommonFunc.setFeatureEnabled(<span class="keyword">this</span>, <span class="keyword">feature_t</span>.folder, <span class="literal">true</span>)</span><br><span class="line">                    <span class="keyword">if</span> score &gt;= <span class="number">10</span> then</span><br><span class="line">                        realTimeFunc.initRealTime(<span class="keyword">this</span>, <span class="keyword">feature_t</span>.folder, <span class="literal">true</span>, <span class="keyword">feature_t</span>.realTimeParams[<span class="number">1</span>])</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        realTimeFunc.initRealTime(<span class="keyword">this</span>, <span class="keyword">feature_t</span>.folder, <span class="literal">true</span>, <span class="keyword">feature_t</span>.realTimeParams[<span class="number">2</span>])</span><br><span class="line">                    end</span><br><span class="line">                    realTimeFunc.setRealTime(<span class="keyword">this</span>, <span class="keyword">feature_t</span>.folder, <span class="string">"u_data"</span>, score)</span><br><span class="line">                end</span><br><span class="line"></span><br><span class="line">            end</span><br><span class="line">            </span><br><span class="line">            lastY = sub.y</span><br><span class="line">        end</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    end,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    handleRecodeVedioEvent = function (<span class="keyword">this</span>, eventCode)</span><br><span class="line">        <span class="keyword">if</span> (init_state ~= <span class="number">0</span>) then</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        end</span><br><span class="line">        <span class="keyword">if</span> (eventCode == <span class="number">1</span>) then</span><br><span class="line">            timeLast = getTime(<span class="keyword">this</span>)</span><br><span class="line">            timeCumu = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">            score = <span class="number">0</span></span><br><span class="line">            gaming = <span class="literal">true</span></span><br><span class="line">            pillar = </span><br><span class="line">            &#123;</span><br><span class="line">                &#123;</span><br><span class="line">                    x = start_x,</span><br><span class="line">                    y = range_y[<span class="number">1</span>] + math.random() * (range_y[<span class="number">2</span>] - range_y[<span class="number">1</span>]),</span><br><span class="line">                    counted = <span class="literal">false</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    x = start_x + interval_x,</span><br><span class="line">                    y = range_y[<span class="number">1</span>] + math.random() * (range_y[<span class="number">2</span>] - range_y[<span class="number">1</span>]),</span><br><span class="line">                    counted = <span class="literal">false</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    x = start_x + interval_x * <span class="number">2</span>,</span><br><span class="line">                    y = range_y[<span class="number">1</span>] + math.random() * (range_y[<span class="number">2</span>] - range_y[<span class="number">1</span>]),</span><br><span class="line">                    counted = <span class="literal">false</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    x = start_x + interval_x * <span class="number">3</span>,</span><br><span class="line">                    y = range_y[<span class="number">1</span>] + math.random() * (range_y[<span class="number">2</span>] - range_y[<span class="number">1</span>]),</span><br><span class="line">                    counted = <span class="literal">false</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    x = start_x + interval_x * <span class="number">4</span>,</span><br><span class="line">                    y = range_y[<span class="number">1</span>] + math.random() * (range_y[<span class="number">2</span>] - range_y[<span class="number">1</span>]),</span><br><span class="line">                    counted = <span class="literal">false</span></span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            sub = </span><br><span class="line">            &#123;</span><br><span class="line">                r = <span class="number">0.105</span>,</span><br><span class="line">                x = <span class="number">0.24</span>,</span><br><span class="line">                y = <span class="number">0.5</span>,</span><br><span class="line">                sy = <span class="number">0.0</span>,</span><br><span class="line">                a = <span class="number">0</span></span><br><span class="line">            &#125;</span><br><span class="line">            lastY = noseY</span><br><span class="line">            <span class="keyword">for</span> i = <span class="number">1</span>,<span class="number">10</span> <span class="keyword">do</span></span><br><span class="line">                Sticker2DV3.playClip(<span class="keyword">this</span>, feature_3.folder, feature_3.entity[<span class="number">1</span>], feature_3.clip[i], <span class="number">0</span>)</span><br><span class="line">                set4Vtx(<span class="keyword">this</span>, feature_3.folder, feature_3.entity[<span class="number">1</span>], feature_3.clip[i], <span class="number">-2</span> , <span class="number">-2</span>, <span class="number">0</span>, <span class="number">0</span> , <span class="number">0.0</span>, <span class="number">0.0</span>, ratio, <span class="number">0.0</span>, <span class="number">0.0</span>)</span><br><span class="line">            end</span><br><span class="line">            <span class="keyword">for</span> i = <span class="number">1</span>,<span class="number">4</span> <span class="keyword">do</span></span><br><span class="line">                Sticker2DV3.stopClip(<span class="keyword">this</span>, feature_0.folder, feature_0.entity[<span class="number">1</span>], feature_0.clip[i])</span><br><span class="line">            end</span><br><span class="line">            set4Vtx(<span class="keyword">this</span>, feature_2.folder, feature_2.entity[<span class="number">1</span>], feature_2.clip[<span class="number">1</span>], <span class="number">-2</span> , <span class="number">-2</span>, <span class="number">0</span>, <span class="number">0</span> , <span class="number">0</span>, <span class="number">0</span>, ratio, <span class="number">0.0</span>, <span class="number">0.0</span>)</span><br><span class="line">            CommonFunc.setFeatureEnabled(<span class="keyword">this</span>, <span class="keyword">feature_t</span>.folder, <span class="literal">false</span>)</span><br><span class="line">        end</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    end,</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>​        然后有几个stcker文件，可以看到有一个是柱子的entity信息，有一个是潜水艇的entity信息，后面那个游戏失败时弹出的那个框框模型。然后每一个stcker文件夹都有两个json文件，其中主要是clip.json，里面主要包含实体的基本信息，还有transform参数。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">"clipname1": &#123;</span><br><span class="line">        "alphaFactor": 1.0,</span><br><span class="line">        "blendmode": 0,</span><br><span class="line">        "fps": 16,</span><br><span class="line">        "height": 801,</span><br><span class="line">        "textureIdx": &#123;</span><br><span class="line">          "idx": [</span><br><span class="line">            <span class="number">0</span></span><br><span class="line">          ],</span><br><span class="line">          "type": "image"</span><br><span class="line">        &#125;,</span><br><span class="line">        "transformParams": &#123;</span><br><span class="line">          "position": &#123;</span><br><span class="line">            "point0": &#123;</span><br><span class="line">              "anchor": [</span><br><span class="line">                0.0,</span><br><span class="line">                <span class="number">0.5</span></span><br><span class="line">              ],</span><br><span class="line">              "point": [</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="attr">"idx"</span>: <span class="string">"topright"</span>,</span><br><span class="line">                  <span class="attr">"relationRef"</span>: <span class="number">0</span>,</span><br><span class="line">                  <span class="attr">"relationType"</span>: <span class="string">"foreground"</span>,</span><br><span class="line">                  <span class="attr">"weight"</span>: <span class="number">0.5635420937542709</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="attr">"idx"</span>: <span class="string">"bottomleft"</span>,</span><br><span class="line">                  <span class="attr">"relationRef"</span>: <span class="number">0</span>,</span><br><span class="line">                  <span class="attr">"relationType"</span>: <span class="string">"foreground"</span>,</span><br><span class="line">                  <span class="attr">"weight"</span>: <span class="number">-0.0793309886223863</span></span><br><span class="line">                &#125;</span><br><span class="line">              ]</span><br><span class="line">            &#125;,</span><br><span class="line">            "point1": &#123;</span><br><span class="line">              "anchor": [</span><br><span class="line">                1.0,</span><br><span class="line">                <span class="number">0.5</span></span><br><span class="line">              ],</span><br><span class="line">              "point": [</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="attr">"idx"</span>: <span class="string">"topright"</span>,</span><br><span class="line">                  <span class="attr">"relationRef"</span>: <span class="number">0</span>,</span><br><span class="line">                  <span class="attr">"relationType"</span>: <span class="string">"foreground"</span>,</span><br><span class="line">                  <span class="attr">"weight"</span>: <span class="number">0.7854868849874516</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="attr">"idx"</span>: <span class="string">"bottomleft"</span>,</span><br><span class="line">                  <span class="attr">"relationRef"</span>: <span class="number">0</span>,</span><br><span class="line">                  <span class="attr">"relationType"</span>: <span class="string">"foreground"</span>,</span><br><span class="line">                  <span class="attr">"weight"</span>: <span class="number">-0.0793309886223863</span></span><br><span class="line">                &#125;</span><br><span class="line">              ]</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          "relation": &#123;</span><br><span class="line">            "foreground": 1</span><br><span class="line">          &#125;,</span><br><span class="line">          "relationIndex": [</span><br><span class="line">            <span class="number">0</span></span><br><span class="line">          ],</span><br><span class="line">          "relationRefOrder": 0,</span><br><span class="line">          "rotationtype": 1,</span><br><span class="line">          "scale": &#123;</span><br><span class="line">            "scaleY": &#123;</span><br><span class="line">              "factor": 1.0</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        </span><br><span class="line">        ....</span><br></pre></td></tr></table></figure>
<p>总结：    </p>
<p>​    从effect资源可以看出，抖音底层有一个类似游戏引擎的这样的渲染框架，然后通过脚本进行控制。功能也应该是挺齐全的，应该是轻量版的引擎，可是麻雀虽小，五脏俱全。</p>
<p>​        对于熟悉游戏引擎的人来说，这部分应该不难，跟游戏引擎模块类似</p>
<p>​        另外，如果想学习引擎这快，我的思路是多去看看一些流行的开源引擎，一开始模仿别人怎么写，然后不断的思考总结，慢慢的你就知道一个引擎应该包含哪些，以及怎么控制各个模块之间的交互。</p>
<p>​        比如我之前深入研究过OGRE，看过OSG，以及深入研究过THREEJS，同时我自己写的渲染引擎，有把这几个引擎比较好的模块模仿过来，逐渐内化成自己的引擎。</p>
<p>​        后面有机会把拆解一下抖音比较复杂的特效吧，最好找一个和AI或者AR结合的特效(挖坑2)</p>
<h3 id="3-关于音视频图形部分"><a href="#3-关于音视频图形部分" class="headerlink" title="3. 关于音视频图形部分"></a>3. 关于音视频图形部分</h3><p>​        这里主要会大概整理一下比较基础的几个部分，包括滤镜、美颜、特效、转场这些，因为我目前好像只做过这些基础的玩法，更加复杂的就涉及到渲染引擎，还有AI图像方面，后面会继续学习研究</p>
<h4 id="3-1-滤镜篇"><a href="#3-1-滤镜篇" class="headerlink" title="3.1 滤镜篇"></a>3.1 滤镜篇</h4><p>现在的滤镜主要还是查找表的形式包括1D/3D LUT，可能有些也会用AI去做，比如风格化迁移等</p>
<p><strong>1D LUT:</strong></p>
<p>调节亮度，对比度，黑白等级256 x 1，只影响Gamma曲线</p>
<p>RGB曲线调节256 x 3</p>
<p>Instagram 里面有很多1D的LUT应用，比如amaro, lomo, Hudson, Sierra…..</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    vec2 uv = gl_FragCoord.st/u_resolution;</span><br><span class="line">    uv.y = <span class="number">1.0</span> - uv.y;</span><br><span class="line"></span><br><span class="line">    vec4 originColor = texture2D(u_texture, uv);</span><br><span class="line">    vec4 texel = texture2D(u_texture, uv);</span><br><span class="line">    vec3 bbTexel = texture2D(u_blowoutTex, uv).rgb;</span><br><span class="line">		<span class="comment">//256x1</span></span><br><span class="line">    texel.r = texture2D(u_overlayTex, vec2(bbTexel.r, texel.r)).r;</span><br><span class="line">    texel.g = texture2D(u_overlayTex, vec2(bbTexel.g, texel.g)).g;</span><br><span class="line">    texel.b = clamp(texture2D(u_overlayTex, vec2(bbTexel.b, texel.b)).b, <span class="number">0.1</span>, <span class="number">0.9</span>);</span><br><span class="line">		<span class="comment">//256x3</span></span><br><span class="line">    vec4 mapped;</span><br><span class="line">    mapped.r = texture2D(u_mapTex, vec2(texel.r, <span class="number">.25</span>)).r;</span><br><span class="line">    mapped.g = texture2D(u_mapTex, vec2(texel.g, <span class="number">.5</span>)).g;</span><br><span class="line">    mapped.b = texture2D(u_mapTex, vec2(texel.b, <span class="number">0.1</span>)).b;</span><br><span class="line">    mapped.a = <span class="number">1.0</span>;</span><br><span class="line"></span><br><span class="line">    mapped.rgb = mix(originColor.rgb, mapped.rgb, <span class="number">1.0</span>);</span><br><span class="line"></span><br><span class="line">    gl_FragColor = mapped;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Amaro 风格</p>
<p><img src="https://i.loli.net/2020/03/30/uyAKFm3Q5n4pDeb.png" alt="amaro.png"></p>
<p>Lomo 风格</p>
<p><img src="https://i.loli.net/2020/03/30/JY8ZePXxi4M9WSC.png" alt="lomo.png"></p>
<p>……</p>
<p><strong>3D LUT:</strong></p>
<p>Lookup table : 64x64 512x512</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//这没啥说的，都是很基本的</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    vec2 uv = gl_FragCoord.st/u_resolution;</span><br><span class="line">    uv.y = <span class="number">1.0</span> - uv.y;</span><br><span class="line">    lowp vec3 textureColor = texture2D(u_texture, uv).rgb;</span><br><span class="line"></span><br><span class="line">    textureColor = clamp((textureColor - vec3(u_levelBlack, u_levelBlack, u_levelBlack)) * u_levelRangeInv, <span class="number">0.0</span>, <span class="number">1.0</span>);</span><br><span class="line">    textureColor.r = texture2D(u_grayTexture, vec2(textureColor.r, <span class="number">0.5</span>)).r;</span><br><span class="line">    textureColor.g = texture2D(u_grayTexture, vec2(textureColor.g, <span class="number">0.5</span>)).g;</span><br><span class="line">    textureColor.b = texture2D(u_grayTexture, vec2(textureColor.b, <span class="number">0.5</span>)).b;</span><br><span class="line"></span><br><span class="line">    mediump <span class="keyword">float</span> blueColor = textureColor.b * <span class="number">15.0</span>;</span><br><span class="line"></span><br><span class="line">    mediump vec2 quad1;</span><br><span class="line">    quad1.y = <span class="built_in">floor</span>(blueColor / <span class="number">4.0</span>);</span><br><span class="line">    quad1.x = <span class="built_in">floor</span>(blueColor) - (quad1.y * <span class="number">4.0</span>);</span><br><span class="line"></span><br><span class="line">    mediump vec2 quad2;</span><br><span class="line">    quad2.y = <span class="built_in">floor</span>(<span class="built_in">ceil</span>(blueColor) / <span class="number">4.0</span>);</span><br><span class="line">    quad2.x = <span class="built_in">ceil</span>(blueColor) - (quad2.y * <span class="number">4.0</span>);</span><br><span class="line"></span><br><span class="line">    highp vec2 texPos1;</span><br><span class="line">    texPos1.x = (quad1.x * <span class="number">0.25</span>) + <span class="number">0.5</span> / <span class="number">64.0</span> + ((<span class="number">0.25</span> - <span class="number">1.0</span> / <span class="number">64.0</span>) * textureColor.r);</span><br><span class="line">    texPos1.y = (quad1.y * <span class="number">0.25</span>) + <span class="number">0.5</span> / <span class="number">64.0</span> + ((<span class="number">0.25</span> - <span class="number">1.0</span> / <span class="number">64.0</span>) * textureColor.g);</span><br><span class="line"></span><br><span class="line">    highp vec2 texPos2;</span><br><span class="line">    texPos2.x = (quad2.x * <span class="number">0.25</span>) + <span class="number">0.5</span> / <span class="number">64.0</span> + ((<span class="number">0.25</span> - <span class="number">1.0</span> / <span class="number">64.0</span>) * textureColor.r);</span><br><span class="line">    texPos2.y = (quad2.y * <span class="number">0.25</span>) + <span class="number">0.5</span> / <span class="number">64.0</span> + ((<span class="number">0.25</span> - <span class="number">1.0</span> / <span class="number">64.0</span>) * textureColor.g);</span><br><span class="line"></span><br><span class="line">    lowp vec4 newColor1 = texture2D(u_lookupTexture, texPos1);</span><br><span class="line">    lowp vec4 newColor2 = texture2D(u_lookupTexture, texPos2);</span><br><span class="line"></span><br><span class="line">    lowp vec3 newColor = mix(newColor1.rgb, newColor2.rgb, fract(blueColor));</span><br><span class="line"></span><br><span class="line">    textureColor = mix(textureColor, newColor, u_strength);</span><br><span class="line"></span><br><span class="line">    gl_FragColor = vec4(textureColor, <span class="number">1.0</span>); </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Fairytale风格</p>
<p><img src="https://i.loli.net/2020/03/30/uRghixNCAPSlbVs.png" alt="Fairytale.png"></p>
<p>​        可以看到3D LUT看起来更加和谐一点，因为3D LUT 的RGB映射关系是关联在一起，1D LUT则是独立的，不过1D LUT可以节省空间，有些只需要单通道就可以搞定的，就可以用1D LUT</p>
<p>​        LUT得益于其简单的生产流程，基本设计师那边用PhotoShop调好一张查找表，这边就应用上去就OK了</p>
<p>相关资料：</p>
<p><a href="https://affinityspotlight.com/article/1d-vs-3d-luts/" target="_blank" rel="noopener">https://affinityspotlight.com/article/1d-vs-3d-luts/</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/37147849" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/37147849</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/60702944" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/60702944</a></p>
<h4 id="3-2-美颜篇"><a href="#3-2-美颜篇" class="headerlink" title="3.2 美颜篇"></a>3.2 美颜篇</h4><ol>
<li><p><strong>磨皮去燥</strong></p>
<p>最简单的方式，就是利用各种降噪滤波器，去掉高频噪声部分</p>
<p>均值模糊 权重分布平均</p>
<p>高斯模糊 权重高斯分布</p>
<p>表面模糊 权重分布只跟颜色空间有关系（与肤色检测配合）</p>
<p>双边滤波 权重分布跟距离和颜色空间分布有关系，</p>
<p>中值模糊 卷积核范围内去中值</p>
<p>导向滤波 参考图像</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">vec4 <span class="title">BilateralFilter</span><span class="params">(vec2 uv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">float</span> i = uv.x;</span><br><span class="line">    <span class="keyword">float</span> j = uv.y;</span><br><span class="line">    <span class="keyword">float</span> sigmaSSquare = <span class="number">2.0</span> * SigmaS * SigmaS;</span><br><span class="line">    <span class="keyword">float</span> sigmaRSquare = <span class="number">2.0</span> * SigmaR * SigmaR;</span><br><span class="line">    vec3 centerColor = texture2D(u_texture, uv).rgb;</span><br><span class="line">    <span class="keyword">float</span> centerGray = Luminance(centerColor);</span><br><span class="line">    vec3 sum_up, sum_down;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> k = -u_radius; k &lt;= u_radius; k++) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> l = -u_radius; l &lt;= u_radius; l++) &#123;</span><br><span class="line">            vec2 uv_new = uv + vec2(k, l)/u_resolution;</span><br><span class="line">            vec3 curColor = texture2D(u_texture, uv_new).rgb;</span><br><span class="line">            <span class="keyword">float</span> curGray = Luminance(curColor);</span><br><span class="line">            vec3 deltaColor = curyolor - centerColor;</span><br><span class="line">            <span class="keyword">float</span> len = dot(deltaColor, deltaColor);</span><br><span class="line">            <span class="keyword">float</span> exponent = -((i-k)*(i-k)+(j-l)*(j-l))/sigmaSSquare - len/sigmaRSquare;</span><br><span class="line">            <span class="keyword">float</span> weight = <span class="built_in">exp</span>(exponent);</span><br><span class="line">            sum_up += curColor * weight;</span><br><span class="line">            sum_down += weight;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    vec3 color = sum_up / sum_down;</span><br><span class="line">    <span class="keyword">return</span> vec4(color, <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">vec4 <span class="title">SurfaceFilter</span><span class="params">(vec2 uv)</span> </span>&#123;</span><br><span class="line">    vec3 centerColor = texture2D(u_texture, uv).rgb;</span><br><span class="line">    vec3 sum_up, sum_down;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> k = -u_radius; k &lt;= u_radius; k++) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> l = -u_radius; l &lt;= u_radius; l++) &#123;</span><br><span class="line">            vec2 uv_new = uv + vec2(k, l)/u_resolution;</span><br><span class="line">            vec3 curColor = texture2D(u_texture, uv_new).rgb;</span><br><span class="line">            vec3 weight = CalculateWeight(curColor, centerColor);</span><br><span class="line">            sum_up += weight * curColor;</span><br><span class="line">            sum_down += weight;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> vec4(sum_up / sum_down, <span class="number">1.0</span>);    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">vec4 <span class="title">gaussian</span><span class="params">(vec2 uv, <span class="keyword">bool</span> horizontalPass)</span> </span>&#123;  </span><br><span class="line">  <span class="keyword">float</span> numBlurPixelsPerSide = <span class="keyword">float</span>(blurSize / <span class="number">2</span>); </span><br><span class="line"></span><br><span class="line">  vec2 blurMultiplyVec = <span class="number">0</span> &lt; horizontalPass ? vec2(<span class="number">1.0</span>, <span class="number">0.0</span>) : vec2(<span class="number">0.0</span>, <span class="number">1.0</span>);</span><br><span class="line"> </span><br><span class="line">  <span class="comment">//高斯函数</span></span><br><span class="line">  vec3 incrementalGaussian;</span><br><span class="line">  incrementalGaussian.x = <span class="number">1.0</span> / (<span class="built_in">sqrt</span>(<span class="number">2.0</span> * pi) * sigma);</span><br><span class="line">  incrementalGaussian.y = <span class="built_in">exp</span>(<span class="number">-0.5</span> / (sigma * sigma));</span><br><span class="line">  incrementalGaussian.z = incrementalGaussian.y * incrementalGaussian.y;</span><br><span class="line"> </span><br><span class="line">  vec4 avgValue = vec4(<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>);</span><br><span class="line">  <span class="keyword">float</span> coefficientSum = <span class="number">0.0</span>;</span><br><span class="line"> </span><br><span class="line">  avgValue += texture2D(texture, vertTexCoord.st) * incrementalGaussian.x;</span><br><span class="line">  coefficientSum += incrementalGaussian.x;</span><br><span class="line">  incrementalGaussian.xy *= incrementalGaussian.yz;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">float</span> i = <span class="number">1.0</span>; i &lt;= numBlurPixelsPerSide; i++) &#123; </span><br><span class="line">    avgValue += texture2D(texture, vertTexCoord.st - i * texOffset * </span><br><span class="line">                          blurMultiplyVec) * incrementalGaussian.x;         </span><br><span class="line">    avgValue += texture2D(texture, vertTexCoord.st + i * texOffset * </span><br><span class="line">                          blurMultiplyVec) * incrementalGaussian.x;         </span><br><span class="line">    coefficientSum += <span class="number">2.0</span> * incrementalGaussian.x;</span><br><span class="line">    incrementalGaussian.xy *= incrementalGaussian.yz;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">return</span> avgValue / coefficientSum;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>比如双边滤波的效果</p>
<p><img src="https://i.loli.net/2020/03/30/8afbrAPmGDF9hq5.png" alt="bilateral.png"></p>
<p>高斯效果</p>
<p><img src="https://i.loli.net/2020/03/30/qMcWOY5Ng24LH9D.png" alt="gaussian.png" style="zoom:50%;"></p>
<p>suface blur 配合肤色检测，可以看出边缘部分有点硬，</p>
<p><img src="https://i.loli.net/2020/03/30/a7jLmSHZ9tNFEwO.png" alt="surface.png" style="zoom:50%;"></p>
<p>2.<strong>美白</strong></p>
<p>HighPass高亮加一点红晕</p>
<p><img src="https://i.loli.net/2020/03/30/tZvFGQOlMb13kTd.png" alt="highpass.png"></p>
<p>3.<strong>美型</strong></p>
<p>美型主要是需要和人脸检测结合起来，对人脸各个部位进行微调，比如：</p>
<ul>
<li>廋脸，根据AI找到的固定脸型的那几个关键点，在各自方向做曲线变形处理</li>
<li>大眼，找到中心点，放大一定的半径</li>
<li>下巴，也是做曲线变形处理</li>
</ul>
<p>类似如下的曲线变形处理</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 曲线形变处理</span></span><br><span class="line"><span class="function">vec2 <span class="title">curveWarp</span><span class="params">(vec2 textureCoord, vec2 originPosition, vec2 targetPosition, <span class="keyword">float</span> radius)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    vec2 offset = vec2(<span class="number">0.0</span>);</span><br><span class="line">    vec2 result = vec2(<span class="number">0.0</span>);</span><br><span class="line"></span><br><span class="line">    vec2 direction = targetPosition - originPosition;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">float</span> infect = distance(textureCoord, originPosition)/radius;</span><br><span class="line"></span><br><span class="line">    infect = <span class="number">1.0</span> - infect;</span><br><span class="line">    infect = clamp(infect, <span class="number">0.0</span>, <span class="number">1.0</span>);</span><br><span class="line">    offset = direction * infect;</span><br><span class="line"></span><br><span class="line">    result = textureCoord - offset;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>……</p>
<p>​    这一块主要是需要准确的关键点处理，然后就是怎么调整曲线了，可以自己注册一个Face++的FaceDetect自己玩一下，包括怎么和贴纸配合，这一块还在总结中，后续会自己研究(挖坑3)</p>
<h4 id="3-3-转场篇"><a href="#3-3-转场篇" class="headerlink" title="3.3 转场篇"></a>3.3 转场篇</h4><p>​        转场主要是涉及到两段视频之间，Shader会有两个Input，然后通过progress控制进度，我理解的转场主要包括以下这些：</p>
<p><strong>1.UV变换</strong></p>
<p>转场很多其实都是UV变化，UV坐标围绕某个点旋转、缩放、平移</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//scale center</span></span><br><span class="line">vec2 scale_uv = vec2(<span class="number">0.5</span> + (tc.x - <span class="number">0.5</span>) / scaleU , <span class="number">0.5</span> + (tc.y - <span class="number">0.5</span>) / scaleV );</span><br><span class="line"></span><br><span class="line"><span class="comment">//rotate</span></span><br><span class="line"><span class="function">vec2 <span class="title">rotateUV</span><span class="params">(vec2 uv, <span class="keyword">float</span> rotation, vec2 mid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">float</span> ratio = (resolution.x / resolution.y);</span><br><span class="line">  <span class="keyword">float</span> s = <span class="built_in">sin</span> ( rotation );</span><br><span class="line">  <span class="keyword">float</span> c = <span class="built_in">cos</span> ( rotation );</span><br><span class="line">  mat2 rotationMatrix = mat2( c, -s, s, c);</span><br><span class="line">  vec2 coord = vec2((uv.x - mid.x) * ratio ,(uv.y -mid.y)*<span class="number">1.0</span>);</span><br><span class="line">  vec2 scaled = rotationMatrix * coord;</span><br><span class="line">  <span class="keyword">return</span> vec2(scaled.x / ratio + mid.x,scaled.y + mid.y);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//translate</span></span><br><span class="line">vec2 translate_uv = vec2(<span class="number">0.5</span> + (tc.x - <span class="number">0.5</span>) / scaleU , <span class="number">0.5</span> + (tc.y - <span class="number">0.5</span>) / scaleV );</span><br></pre></td></tr></table></figure>
<p>怎么控制进度就慢慢调吧</p>
<p><strong>2.Blend转场</strong></p>
<p>首先熟悉一下PhotoShop里面的混合模式alphe混合、滤色、加深、减淡、高亮度等等</p>
<p><a href="https://zhuanlan.zhihu.com/p/23905865" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/23905865</a></p>
<p>然后就可以慢慢玩了</p>
<p><strong>3.模糊转场</strong></p>
<p>主要也是Photoshop里面的几种模糊方式，旋转模糊、高斯模糊、均值模糊等等</p>
<p>需要注意一下旋转模糊，我实现过一种旋转模糊的转场，需要配合随机采样</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">rand</span><span class="params">(vec2 uv)</span></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> fract(<span class="built_in">sin</span>(dot(uv.xy ,vec2(<span class="number">12.9898</span>,<span class="number">78.233</span>))) * <span class="number">43758.5453</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">vec4 <span class="title">rotation_blur</span><span class="params">(vec2 tc)</span> </span>&#123;</span><br><span class="line">  angle = angle * PI_ROTATION / <span class="number">180.0</span>;</span><br><span class="line">  vec2 uv = tc;</span><br><span class="line">  <span class="keyword">float</span> uv_random = rand(uv);</span><br><span class="line">  vec4 sum_color = vec4(<span class="number">0.0</span>);</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">float</span> i = <span class="number">0.0</span>; i &lt; samples; i++) &#123;</span><br><span class="line">    <span class="keyword">float</span> percent = (i + uv_random) / samples;</span><br><span class="line">    <span class="keyword">float</span> real_angle = angle + percent * strength;</span><br><span class="line">    real_angle = mod(real_angle, PI_ROTATION);</span><br><span class="line">    vec2 uv_rotation = rotateUV(uv, real_angle, center);</span><br><span class="line">    sum_color += INPUT(fract(uv_rotation));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> sum_color / samples;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And 这里有个转场的网站，可以研究一下</p>
<p><a href="https://gl-transitions.com/" target="_blank" rel="noopener">https://gl-transitions.com/</a></p>
<h4 id="3-4-特效篇"><a href="#3-4-特效篇" class="headerlink" title="3.4 特效篇"></a>3.4 特效篇</h4><p>基础的特效包括：抖动、灵魂出窍、故障风、光晕、老电影、粒子特效等等</p>
<p>比如old film</p>
<p><img src="https://i.loli.net/2020/03/30/GutfwzVTk2LlC1h.png" alt="old_film.png" style="zoom:50%;"></p>
<p>比如glitch风格(动态的会好一点)</p>
<p><img src="https://i.loli.net/2020/03/30/sPNvIylF56gkYzQ.png" alt="glitch.png" style="zoom:50%;"></p>
<p>​       这些特效都不难，网上Shader到处都是，基本copy下来调调参数就行，可能也就粒子特效需要调很多细节，但如果你有图形引擎的基础，这些都很简单，到时候我可以建个仓库，share一些我自己实现的shader</p>
<p>一般特效的话可以先去网上找，比如shadertoy</p>
<p><a href="https://www.shadertoy.com/" target="_blank" rel="noopener">https://www.shadertoy.com/</a></p>
<p>如果找不到的话，需要自己去想怎么实现，我一般是会按如下的方式去思考：</p>
<ol>
<li>善于利用各种卷积滤波器(边缘检测、模糊)，有时候需要和随机采样结合</li>
<li>熟悉各种颜色空间，熟悉饱和度、锐度、亮度、色度等基础调节</li>
<li>UV变换多写几个有经验了，然后理解一些曲线函数，基本都能慢慢调出来</li>
<li>可以试着看看相关论文，或者OpenCV的实现方式</li>
</ol>
<p>简单的特效实现起来并不难，多去写，慢慢总结经验的套路，如果更深入一点可能需要图形图像和数学的知识</p>
<h4 id="3-5-串联这些效果"><a href="#3-5-串联这些效果" class="headerlink" title="3.5 串联这些效果"></a>3.5 串联这些效果</h4><p>​    可能大家比较熟悉的就是GPUImage了，基本都是用这个去串联这些特效、滤镜之类，关于GPUImage网上也有很多资料，这里就不具体讲了，也比较简单，内部就是一个Input一个output通过FBO串起来。这里主要想推荐大家看下movit这个框架，基本跟GPUImage类似，支持单个input和多个input，可以打断中间节点，也可以有FrameBufferCache机制，但他还有一个优化的点就是，Shader动态组装机制，熟悉游戏引擎应该都知道这个，Shader是可以在最后动态生成，他里面是通过宏define来控制，可以把一些列串联特效组装到一起，非常高效，后面可以单独讲讲这块。</p>
<p>只需要看下他组装shader的过程：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">unsigned</span> i = <span class="number">0</span>; i &lt; phase-&gt;effects.size(); ++i) &#123;</span><br><span class="line">	Node *node = phase-&gt;effects[i];</span><br><span class="line">	<span class="keyword">const</span> <span class="built_in">string</span> effect_id = phase-&gt;effect_ids[make_pair(node, IN_SAME_PHASE)];</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">unsigned</span> j = <span class="number">0</span>; j &lt; node-&gt;incoming_links.size(); ++j) &#123;</span><br><span class="line">		<span class="keyword">if</span> (node-&gt;incoming_links.size() == <span class="number">1</span>) &#123;</span><br><span class="line">			frag_shader += <span class="string">"#define INPUT"</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">char</span> buf[<span class="number">256</span>];</span><br><span class="line">			<span class="built_in">sprintf</span>(buf, <span class="string">"#define INPUT%d"</span>, j + <span class="number">1</span>);</span><br><span class="line">			frag_shader += buf;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		Node *input = node-&gt;incoming_links[j];</span><br><span class="line">		NodeLinkType link_type = node-&gt;incoming_link_type[j];</span><br><span class="line">		<span class="keyword">if</span> (i != <span class="number">0</span> &amp;&amp;</span><br><span class="line">		    input-&gt;effect-&gt;is_compute_shader() &amp;&amp;</span><br><span class="line">		    node-&gt;incoming_link_type[j] == IN_SAME_PHASE) &#123;</span><br><span class="line">			<span class="comment">// First effect after the compute shader reads the value</span></span><br><span class="line">			<span class="comment">// that cs_output() wrote to a global variable,</span></span><br><span class="line">			<span class="comment">// ignoring the tc (since all such effects have to be</span></span><br><span class="line">			<span class="comment">// strong one-to-one).</span></span><br><span class="line">			frag_shader += <span class="string">"(tc) CS_OUTPUT_VAL\n"</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			assert(phase-&gt;effect_ids.count(make_pair(input, link_type)));</span><br><span class="line">			frag_shader += <span class="built_in">string</span>(<span class="string">" "</span>) + phase-&gt;effect_ids[make_pair(input, link_type)] + <span class="string">"\n"</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	frag_shader += <span class="string">"\n"</span>;</span><br><span class="line">	frag_shader += <span class="built_in">string</span>(<span class="string">"#define FUNCNAME "</span>) + effect_id + <span class="string">"\n"</span>;</span><br><span class="line">	<span class="keyword">if</span> (node-&gt;effect-&gt;is_compute_shader()) &#123;</span><br><span class="line">		frag_shader += <span class="built_in">string</span>(<span class="string">"#define NORMALIZE_TEXTURE_COORDS(tc) ((tc) * "</span>) + effect_id + <span class="string">"_inv_output_size + "</span> + effect_id + <span class="string">"_output_texcoord_adjust)\n"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	frag_shader += replace_prefix(node-&gt;effect-&gt;output_fragment_shader(), effect_id);</span><br><span class="line">	frag_shader += <span class="string">"#undef FUNCNAME\n"</span>;</span><br><span class="line">	<span class="keyword">if</span> (node-&gt;incoming_links.size() == <span class="number">1</span>) &#123;</span><br><span class="line">		frag_shader += <span class="string">"#undef INPUT\n"</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">unsigned</span> j = <span class="number">0</span>; j &lt; node-&gt;incoming_links.size(); ++j) &#123;</span><br><span class="line">			<span class="keyword">char</span> buf[<span class="number">256</span>];</span><br><span class="line">			<span class="built_in">sprintf</span>(buf, <span class="string">"#undef INPUT%d\n"</span>, j + <span class="number">1</span>);</span><br><span class="line">			frag_shader += buf;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	frag_shader += <span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完了之后可以生成类似如下的shader：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">precision highp <span class="keyword">float</span>;</span><br><span class="line">varying vec2 tc;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FUNCNAME eff0</span></span><br><span class="line">uniform sampler2D eff0_tex;</span><br><span class="line"><span class="function">vec4 <span class="title">FUNCNAME</span><span class="params">(vec2 tc)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> texture2D(eff0_tex, vec2(tc.x,<span class="number">1.0</span>-tc.y));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> PREFIX</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> FUNCNAME</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INPUT eff0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FUNCNAME eff1</span></span><br><span class="line">uniform <span class="keyword">float</span> eff1_strength;</span><br><span class="line">uniform sampler2D eff1_lut;</span><br><span class="line"><span class="function">vec4 <span class="title">FUNCNAME</span><span class="params">(vec2 tc)</span> </span>&#123; </span><br><span class="line">    <span class="keyword">float</span> strength = eff1_strength;</span><br><span class="line">    lowp vec4 textureColor = INPUT(tc); </span><br><span class="line">    mediump <span class="keyword">float</span> blueColor = textureColor.b * <span class="number">63.0</span>;</span><br><span class="line">    mediump vec2 quad1; quad1.y = <span class="built_in">floor</span>(<span class="built_in">floor</span>(blueColor) / <span class="number">8.0</span>); </span><br><span class="line">    quad1.x = <span class="built_in">floor</span>(blueColor) - (quad1.y * <span class="number">8.0</span>); </span><br><span class="line">    mediump vec2 quad2; </span><br><span class="line">    quad2.y = <span class="built_in">floor</span>(<span class="built_in">ceil</span>(blueColor) / <span class="number">8.0</span>); </span><br><span class="line">    quad2.x = <span class="built_in">ceil</span>(blueColor) - (quad2.y * <span class="number">8.0</span>); </span><br><span class="line">    highp vec2 texPos1; </span><br><span class="line">    texPos1.x = (quad1.x * <span class="number">0.125</span>) + <span class="number">0.5</span>/<span class="number">512.0</span> + ((<span class="number">0.125</span> - <span class="number">1.0</span>/<span class="number">512.0</span>) * textureColor.r); </span><br><span class="line">  	texPos1.y = (quad1.y * <span class="number">0.125</span>) + <span class="number">0.5</span>/<span class="number">512.0</span> + ((<span class="number">0.125</span> - <span class="number">1.0</span>/<span class="number">512.0</span>) * textureColor.g);</span><br><span class="line">    highp vec2 texPos2; </span><br><span class="line">    texPos2.x = (quad2.x * <span class="number">0.125</span>) + <span class="number">0.5</span>/<span class="number">512.0</span> + ((<span class="number">0.125</span> - <span class="number">1.0</span>/<span class="number">512.0</span>) * textureColor.r);</span><br><span class="line">    texPos2.y = (quad2.y * <span class="number">0.125</span>) + <span class="number">0.5</span>/<span class="number">512.0</span> + ((<span class="number">0.125</span> - <span class="number">1.0</span>/<span class="number">512.0</span>) * textureColor.g);</span><br><span class="line">    lowp vec4 newColor1 = texture2D(eff1_lut, texPos1); </span><br><span class="line">    lowp vec4 newColor2 = texture2D(eff1_lut, texPos2); </span><br><span class="line">    lowp vec4 newColor = mix(newColor1, newColor2, fract(blueColor)); </span><br><span class="line">    <span class="keyword">return</span> mix(textureColor, vec4(newColor.rgb, textureColor.w), strength);</span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> PREFIX</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> FUNCNAME</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> INPUT</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INPUT eff1</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    gl_FragColor = INPUT(tc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​        直接通过一个#define FUNCNAME就可以串起来，我以前写的那个渲染引擎，也是动态组装shader，跟这个有点类似，不过比这个复杂，需要更多的宏来控制，有兴趣可以去看看</p>
<p>Movit源码：<a href="https://git.sesse.net/?p=movit;a=summary" target="_blank" rel="noopener">https://git.sesse.net/?p=movit;a=summary</a></p>
<h3 id="4-关于音视频处理"><a href="#4-关于音视频处理" class="headerlink" title="4. 关于音视频处理"></a>4. 关于音视频处理</h3><h4 id="4-1-音视频理论知识"><a href="#4-1-音视频理论知识" class="headerlink" title="4.1 音视频理论知识"></a>4.1 音视频理论知识</h4><ol>
<li>H264/H265编码原理，宏快怎么划分</li>
<li>I、P、B帧压缩方式</li>
<li>SPS/PPS 信息</li>
<li>音频的采样率</li>
<li>封装格式(MP4, FLV)，MP4的Box形式存储</li>
<li>YUV数据</li>
</ol>
<h4 id="4-2-编解码部分"><a href="#4-2-编解码部分" class="headerlink" title="4.2 编解码部分"></a>4.2 编解码部分</h4><p>音视频解码基本流程</p>
<p><img src="https://i.loli.net/2020/03/30/WlHf3MyvSE5XI61.jpg" alt="codec.jpeg"></p>
<p>参考：</p>
<p><a href="https://blog.csdn.net/leixiaohua1020/article/details/18893769" target="_blank" rel="noopener">https://blog.csdn.net/leixiaohua1020/article/details/18893769</a></p>
<p>1.<strong>硬解部分(Android MediaCodec)</strong></p>
<p>在低端平台更多的需要依赖硬件解码，效率会更高，Android MediaCodec</p>
<p><img src="https://i.loli.net/2020/03/30/pb9zQeStANWLZf1.png" alt="mediacodec.png"></p>
<p><a href="https://developer.android.com/reference/android/media/MediaCodec?hl=en" target="_blank" rel="noopener">https://developer.android.com/reference/android/media/MediaCodec?hl=en</a></p>
<p>大概的代码逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (!m_sawOutputEOS) &#123;</span><br><span class="line">			<span class="keyword">if</span> (!m_sawInputEOS) &#123;</span><br><span class="line">				<span class="comment">// Feed more data to the decoder</span></span><br><span class="line">				<span class="keyword">final</span> <span class="keyword">int</span> inputBufIndex = m_decoder.dequeueInputBuffer(TIMEOUT_USEC);</span><br><span class="line">				<span class="keyword">if</span> (inputBufIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">					ByteBuffer inputBuf = m_decoderInputBuffers[inputBufIndex];</span><br><span class="line">					<span class="comment">// Read the sample data into the ByteBuffer. This neither</span></span><br><span class="line">					<span class="comment">// respects nor</span></span><br><span class="line">					<span class="comment">// updates inputBuf's position, limit, etc.</span></span><br><span class="line">					<span class="keyword">final</span> <span class="keyword">int</span> chunkSize = m_extractor.readSampleData(inputBuf, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">					<span class="keyword">if</span> (m_verbose)</span><br><span class="line">						Log.d(TAG, <span class="string">"input packet length: "</span> + chunkSize + <span class="string">" time stamp: "</span> + m_extractor.getSampleTime());</span><br><span class="line"></span><br><span class="line">					<span class="keyword">if</span> (chunkSize &lt; <span class="number">0</span>) &#123;</span><br><span class="line">						<span class="comment">// End of stream -- send empty frame with EOS flag set.</span></span><br><span class="line">						m_decoder.queueInputBuffer(inputBufIndex, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0L</span>, MediaCodec.BUFFER_FLAG_END_OF_STREAM);</span><br><span class="line">						m_sawInputEOS = <span class="keyword">true</span>;</span><br><span class="line">						<span class="keyword">if</span> (m_verbose)</span><br><span class="line">							Log.d(TAG, <span class="string">"Sent input EOS"</span>);</span><br><span class="line">					&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">						<span class="keyword">if</span> (m_extractor.getSampleTrackIndex() != m_videoTrackIndex) &#123;</span><br><span class="line">							Log.w(TAG, <span class="string">"WEIRD: got sample from track "</span> + m_extractor.getSampleTrackIndex()</span><br><span class="line">									+ <span class="string">", expected "</span> + m_videoTrackIndex);</span><br><span class="line">						&#125;</span><br><span class="line"></span><br><span class="line">						<span class="keyword">long</span> presentationTimeUs = m_extractor.getSampleTime();</span><br><span class="line"></span><br><span class="line">						m_decoder.queueInputBuffer(inputBufIndex, <span class="number">0</span>, chunkSize, presentationTimeUs, <span class="number">0</span>);</span><br><span class="line">						<span class="keyword">if</span> (m_verbose)</span><br><span class="line">							Log.d(TAG,</span><br><span class="line">									<span class="string">"Submitted frame to decoder input buffer "</span> + inputBufIndex + <span class="string">", size="</span> + chunkSize);</span><br><span class="line"></span><br><span class="line">						m_inputBufferQueued = <span class="keyword">true</span>;</span><br><span class="line">						++m_pendingInputFrameCount;</span><br><span class="line">						<span class="keyword">if</span> (m_verbose)</span><br><span class="line">							Log.d(TAG, <span class="string">"Pending input frame count increased: "</span> + m_pendingInputFrameCount);</span><br><span class="line"></span><br><span class="line">						m_extractor.advance();</span><br><span class="line">						m_extractorInOriginalState = <span class="keyword">false</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="keyword">if</span> (m_verbose)</span><br><span class="line">						Log.d(TAG, <span class="string">"Input buffer not available"</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> decoderStatus = m_decoder.dequeueOutputBuffer(m_bufferInfo, dequeueTimeoutUs);</span><br><span class="line">	<span class="keyword">if</span> (decoderStatus == MediaCodec.INFO_TRY_AGAIN_LATER) &#123;</span><br><span class="line">				<span class="comment">// No output available yet</span></span><br><span class="line">				<span class="keyword">if</span> (m_verbose)</span><br><span class="line">					Log.d(TAG, <span class="string">"No output from decoder available"</span>);</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (decoderStatus == MediaCodec.INFO_OUTPUT_BUFFERS_CHANGED) &#123;</span><br><span class="line">				<span class="comment">// Not important for us, since we're using Surface</span></span><br><span class="line">				<span class="keyword">if</span> (m_verbose)</span><br><span class="line">					Log.d(TAG, <span class="string">"Decoder output buffers changed"</span>);</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (decoderStatus == MediaCodec.INFO_OUTPUT_FORMAT_CHANGED) &#123;</span><br><span class="line">				MediaFormat newFormat = m_decoder.getOutputFormat();</span><br><span class="line">				<span class="keyword">if</span> (m_verbose)</span><br><span class="line">					Log.d(TAG, <span class="string">"Decoder output format changed: "</span> + newFormat);</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (decoderStatus &lt; <span class="number">0</span>) &#123;</span><br><span class="line">				Log.e(TAG, <span class="string">"Unexpected result from decoder.dequeueOutputBuffer: "</span> + decoderStatus);</span><br><span class="line">				<span class="keyword">return</span> ERROR_FAIL;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    		<span class="comment">///....</span></span><br><span class="line">        m_decoder.releaseOutputBuffer(decoderStatus, doRender);</span><br><span class="line">  		&#125;</span><br><span class="line"> 	&#125;</span><br></pre></td></tr></table></figure>
<p>解码过程网上到处都是，解码主要就是配合MediaExtrator，直接说一下需要注意的点：</p>
<ul>
<li>getOutputBuffer得到的数据格式主要是YUV420P和YUV420SP，UV通道排列不一样</li>
<li>seekTo完之后要Flush</li>
<li>configure如果传入surface则是直接decode到suface上，不同通过getOutputBuffer获取数据</li>
</ul>
<p>2.<strong>软解部分(FFMPEG)</strong></p>
<p>​         其实现在绝大部分音视频APP编解码都是用的FFMPEG，这里门也包含了硬解MediaCodec部分，所以只需要用FFMPEG就可以做硬解和软解的切换。关于FFMPEG的学习，首推肯定是雷神的博客啦，</p>
<p><a href="https://blog.csdn.net/leixiaohua1020/article/details/15811977" target="_blank" rel="noopener">https://blog.csdn.net/leixiaohua1020/article/details/15811977</a></p>
<p>主要包括两个部分，首先是prepare部分，</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (avformat_open_input(&amp;mFormatContext, path.c_str(), <span class="literal">NULL</span>, <span class="literal">NULL</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        mlt_log_error(mProducer, <span class="string">"Could not open input file: %s"</span>, path.c_str());</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (avformat_find_stream_info(mFormatContext, <span class="literal">NULL</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">  mlt_log_error(mProducer, <span class="string">"Could not find stream information"</span>);</span><br><span class="line">  <span class="keyword">goto</span> error;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mVideoStreamIndex = findPreferedVideoStream();<span class="comment">//遍历track找到视频轨</span></span><br><span class="line">mVideoStream = mFormatContext-&gt;streams[mVideoStreamIndex];</span><br><span class="line"></span><br><span class="line"><span class="comment">//然后就可以得到一些列参数，width，height，fps，fromat</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//如果是硬解</span></span><br><span class="line"><span class="comment">//根据不同的编码器，找到对应的解码器，如H264，H265等</span></span><br><span class="line">mVideoCodec = avcodec_find_decoder_by_name(<span class="string">"h264_mediacodec"</span>);;</span><br><span class="line"></span><br><span class="line"><span class="comment">//如果是软解</span></span><br><span class="line">mVideoCodec = avcodec_find_decoder(mVideoStream-&gt;codecpar-&gt;codec_id);</span><br><span class="line"></span><br><span class="line"><span class="comment">//open</span></span><br><span class="line">avcodec_open2(mVideoCodecContext, mVideoCodec, <span class="literal">NULL</span>)</span><br><span class="line"><span class="comment">//就可以开始解码了</span></span><br></pre></td></tr></table></figure>
<p>解码部分</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mPacket) &#123;</span><br><span class="line">            ret = getVideoPacket();</span><br><span class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span> &amp;&amp; ret != AVERROR_EOF) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">				<span class="comment">//这里面送包的时候有很多细节</span></span><br><span class="line">  			<span class="keyword">int</span> ret = avcodec_send_packet(mVideoCodecContext, flush ? <span class="literal">NULL</span> : mPacket);</span><br><span class="line">  			<span class="keyword">if</span> (ret &gt;= <span class="number">0</span>)</span><br><span class="line">            freeVideoPacket();</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ret &lt; <span class="number">0</span> &amp;&amp; ret != AVERROR_EOF &amp;&amp; ret != AVERROR(EAGAIN)) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ret = avcodec_receive_frame(mVideoCodecContext, mFrame);</span><br><span class="line">        <span class="keyword">if</span> (ret &gt;= <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">            ret = DECODER_FFMPEG_SUCCESS;</span><br><span class="line">          	<span class="comment">//计算pts</span></span><br><span class="line">            mCurrentPos = getTime(mFrame-&gt;pts == AV_NOPTS_VALUE ? mFrame-&gt;pkt_dts : mFrame-&gt;pts);</span><br><span class="line">            pts = mCurrentPos;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ++count;</span><br><span class="line">    &#125; <span class="keyword">while</span> (ret &lt; DECODER_FFMPEG_SUCCESS &amp;&amp; count &lt; DECODER_TRY_ATTEMPTS);</span><br><span class="line"></span><br><span class="line"><span class="comment">//后面就是针对不同的格式，接入数据，</span></span><br><span class="line"><span class="comment">//还可以通过swscaleFrame进行转码，转成你想要的格式</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//然后就是copy AVFrame里面的数据啦</span></span><br></pre></td></tr></table></figure>
<p>关于FFMPEG有太多可以去学习的了，比如：</p>
<ul>
<li>学会用ffmpeg ffprobe ffplay一些命令，真的非常强大，方便分析问题(ffprobe -i xxxx)</li>
<li>怎么去切换软解和硬码</li>
<li>熟悉API返回的状态</li>
</ul>
<p><strong>然后就是兼容性的问题</strong>：</p>
<p>​      由于Android平台太复杂了，厂商很多，所以会有无穷无尽的兼容性问题需要去解决，总体来说兼容性问题主要包括：</p>
<ul>
<li>数据源的兼容性，YUV格式非常多样，420p/420sp是常见的，还有yuv420p10le 这种10bit，贼坑</li>
<li>硬件平台的兼容性，这里坑就更多了，MediaCodec支持程度，尤其是低端机非常需要注意</li>
<li>分辨率问题，4K/8K，高通平台的支持程度</li>
</ul>
<p>这个后续单独去整理吧……(挖坑4)</p>
<h4 id="4-3-音视频同步"><a href="#4-3-音视频同步" class="headerlink" title="4.3 音视频同步"></a>4.3 音视频同步</h4><p>视音频同步的实现方式其实有三种，分别是：</p>
<ul>
<li>以音频为主时间轴作为同步源;</li>
<li>以视频为主时间轴作为同步源;</li>
<li><p>以外部时钟为主时间轴作为同步源;</p>
<p>​具体用哪一种需要根据场景，比如在线视频播放器，一般会以第一种音频作为主时间轴去对齐视频帧数据，做丢帧和用当前帧处理，比如我之前写的音视频编辑SDK，因为我们有一条固定帧率的时间线，所以我们的对齐方式是以这条固定时间轴来对齐视频。</p>
<p>​比如当前时间轴如果大于当前decode出来的帧的pts，就直接丢掉，继续找下一帧，如果当前时间轴小于decode出来的帧的pts，超过1一帧的时间就继续用上一帧渲染即可。</p>
</li>
</ul>
<h4 id="4-4-多视频多轨道-进阶"><a href="#4-4-多视频多轨道-进阶" class="headerlink" title="4.4 多视频多轨道(进阶)"></a>4.4 多视频多轨道(进阶)</h4><p><img src="https://i.loli.net/2020/03/30/Eng8sV6jF1NQfdr.png" alt="multi_track.png"></p>
<p>​        视频编辑SDK肯定是需要支持多视频多轨道编辑，如何高效的管理，方便编辑和预览，这里面主要是需要一个好的Multi track的框架支撑，组里面大佬把MLT框架直接拿过用了，这个框架对于多视频多轨道处理真的非常强大，内部有精确的时间戳对齐逻辑，也可以和很多插件配合使用</p>
<p>​    基本框架</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+--------+   +------+   +--------+</span><br><span class="line">|Producer|--&gt;|Filter|--&gt;|Consumer|</span><br><span class="line">+--------+   +------+   +--------+</span><br></pre></td></tr></table></figure>
<p>具体看Github</p>
<p><a href="https://github.com/mltframework/mlt" target="_blank" rel="noopener">https://github.com/mltframework/mlt</a></p>
<h3 id="5-关于传输"><a href="#5-关于传输" class="headerlink" title="5. 关于传输"></a>5. 关于传输</h3><p>这块没做过，对传输协议不太了解，只知道一些理论知识，比如RTMP的分块传输，后面有机会再补齐</p>
<h4 id="5-1-RTMP"><a href="#5-1-RTMP" class="headerlink" title="5.1 RTMP"></a>5.1 RTMP</h4><h3 id="6-分析音视频APP"><a href="#6-分析音视频APP" class="headerlink" title="6. 分析音视频APP"></a>6. 分析音视频APP</h3><p>​    在开发过程中，对于一个小白来说可能会经常遇到一筹莫展的时候，这时候要学会向同类优秀的应用学习，比如做短视频相关的可以去看抖音/快手怎么做的，做音视频剪辑相关的可以看看见剪映/快影/小影怎么做的，你可以去把他们的包pull出来，比如我在做资源的接入的时候，就对比过快手/抖音/大疆 这几家的资源，看他们的sticker怎样接入，有png序列，有MP4，有自定义GIF格式的。所以从这些APP的packge内部还是能找到一些线索，跟着这些线索再慢慢找到其内部的逻辑，就比如我上面分析抖音潜水艇那个游戏一样，当然也可以去分析其它的一些文件，给你提供思路。</p>
<h4 id="1-抖音"><a href="#1-抖音" class="headerlink" title="1. 抖音"></a>1. 抖音</h4><p>Package name: com.ss.android.ugc.aweme</p>
<p>adb pull /data/data/com.ss.android.ugc.aweme</p>
<p><img src="https://i.loli.net/2020/03/30/1edpLhX8VuN9HwI.png" alt="tiktok_package.png" style="zoom:50%;"></p>
<p>主要是分析了一下里面的Effect资源，还有LOG信息, 后面可以有机会继续拆解一下(挖坑5)</p>
<h4 id="2-快手"><a href="#2-快手" class="headerlink" title="2. 快手"></a>2. 快手</h4><p>Package name: com.smile.gifmaker</p>
<p>同样的方式</p>
<h4 id="3-大疆"><a href="#3-大疆" class="headerlink" title="3. 大疆"></a>3. 大疆</h4><p>Package name: dji.mimo</p>
<p>​    主要是DJI mimo，但是做的比较烂，所以没有太多可分析的，不过通过他们的sticker资源可以看到他们支持alpha通道视频的原理，后面有类似需求也可以拿过来用</p>
<h3 id="7-总结"><a href="#7-总结" class="headerlink" title="7. 总结"></a>7. 总结</h3><p>现在是凌晨3点多，从周日从早上开始写到晚上3点，差不多用了将近18个小时来整理[吐血]。想想上一次博客更新差不多是两年前了，那时候是做图形渲染相关的事情，也试着自己写了一个渲染引擎，结合了不错的开源引擎，写完之后对我图形方向的理解有很大的进步，于是试着开始写了几篇博客，继续维护自己关于图形方向的研究，后面由于各种原因，没有继续在维护之前的图形引擎，自己也不在更新博客了。</p>
<p>​    今天以音视频作为新的方向，重新回来，把自己这两年的一些积累整理出来，希望能对后面的学习者有所帮助，我也会尽力去打磨好每一篇博客，今天这遍博客只是总结一个大的框架，里面有非常非常多的细节，都可单独用一篇文章去讲，比如关于Camera，音视频特效，编解码，兼容性这些，都需要花时间去一点一点研究。我也会对自己每一篇文章有严格的要求，要么不写，要写就尽量按照论文的形式把每一个点讲清楚，结合流程图和效果图，最后还需要给出Demo复现效果。</p>
<p>​    还是开头那句话，随着5G是时代的到来，音视频的应用将会更加普及，这方面的人才也会更加紧缺，同时对于这里面的技术要求也会越来越高，从现在开始就慢慢积累，完善里面的技能栈，也可以选择一个分支去深入下去，这里面有很多的方向都值得研究。也希望以这篇文章为起点，寻找一些志同道合之人，一起去探索一些音视频方向的玩法，当然还有相机这块，因为我之前一直是做相机相关的，也思考过相机有什么好的方向可以去探索。</p>
<p>​    总之，我会一直做音视频这个方向，抖音和快手在视频玩法上做到了极致，手机厂商不断的升级Camera，也越来越重视视频的采集，让手机作为拍摄工具可以拍出更加震撼的效果，还有大疆在无人机领域视角去采集的视频数据，也可以做出很多大片效果，还有Insta360在全景方向的玩法，做的也很棒，未来随着硬件设备的升级，还会出现更多有趣的玩法，比如和AR/VR结合在一起，又会有怎样的火花呢，我们拭目以待。</p>
<blockquote>
<p>人生只有一次，做自己喜欢的事吧</p>
</blockquote>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>Donate</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.jpg" alt="yanglusheng WeChat Pay">
        <p>WeChat Pay</p>
      </div>
    

    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/图形图像/" rel="tag"># 图形图像</a>
          
            <a href="/tags/音视频/" rel="tag"># 音视频</a>
          
            <a href="/tags/Camera/" rel="tag"># Camera</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/12/15/（url中显示的标题）/" rel="next" title="SimpleRenderEngineV1.0功能设计思想">
                <i class="fa fa-chevron-left"></i> SimpleRenderEngineV1.0功能设计思想
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="SOHUCS"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="http://ovi6hpv55.bkt.clouddn.com/%E5%A4%B4%E5%83%8F.jpg" alt="yanglusheng">
          <p class="site-author-name" itemprop="name">yanglusheng</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">12</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/LukiYLS" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/Y-lusheng" target="_blank" title="Zhihu">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                    
                      Zhihu
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-关于音视频数据采集-Android"><span class="nav-number">1.</span> <span class="nav-text">1. 关于音视频数据采集(Android)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-Android-Camera-API"><span class="nav-number">1.1.</span> <span class="nav-text">1.1 Android Camera API</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-Camera-HAL"><span class="nav-number">1.2.</span> <span class="nav-text">1.2 Camera HAL</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-CameraX"><span class="nav-number">1.3.</span> <span class="nav-text">1.3 CameraX</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-4-Camera专业视频-进阶"><span class="nav-number">1.4.</span> <span class="nav-text">1.4 Camera专业视频(进阶)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-关于图形渲染"><span class="nav-number">2.</span> <span class="nav-text">2. 关于图形渲染</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-图形学基础"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 图形学基础</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-OpenGL-GLES"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 OpenGL/GLES</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-音视频渲染引擎-扒抖音"><span class="nav-number">2.3.</span> <span class="nav-text">2.3 音视频渲染引擎(扒抖音)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-关于音视频图形部分"><span class="nav-number">3.</span> <span class="nav-text">3. 关于音视频图形部分</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-滤镜篇"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 滤镜篇</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-美颜篇"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 美颜篇</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-转场篇"><span class="nav-number">3.3.</span> <span class="nav-text">3.3 转场篇</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-特效篇"><span class="nav-number">3.4.</span> <span class="nav-text">3.4 特效篇</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-5-串联这些效果"><span class="nav-number">3.5.</span> <span class="nav-text">3.5 串联这些效果</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-关于音视频处理"><span class="nav-number">4.</span> <span class="nav-text">4. 关于音视频处理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-音视频理论知识"><span class="nav-number">4.1.</span> <span class="nav-text">4.1 音视频理论知识</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-编解码部分"><span class="nav-number">4.2.</span> <span class="nav-text">4.2 编解码部分</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-音视频同步"><span class="nav-number">4.3.</span> <span class="nav-text">4.3 音视频同步</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-4-多视频多轨道-进阶"><span class="nav-number">4.4.</span> <span class="nav-text">4.4 多视频多轨道(进阶)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-关于传输"><span class="nav-number">5.</span> <span class="nav-text">5. 关于传输</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-1-RTMP"><span class="nav-number">5.1.</span> <span class="nav-text">5.1 RTMP</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-分析音视频APP"><span class="nav-number">6.</span> <span class="nav-text">6. 分析音视频APP</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-抖音"><span class="nav-number">6.1.</span> <span class="nav-text">1. 抖音</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-快手"><span class="nav-number">6.2.</span> <span class="nav-text">2. 快手</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-大疆"><span class="nav-number">6.3.</span> <span class="nav-text">3. 大疆</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-总结"><span class="nav-number">7.</span> <span class="nav-text">7. 总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yanglusheng</span>

  
</div>





        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>







  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  




  
    <script type="text/javascript">
    (function(){
      var appid = 'cytbQ8t9f';
      var conf = 'a29593692d36dd6143fc58db5ae3845f';
      var width = window.innerWidth || document.documentElement.clientWidth;
      if (width < 960) {
      window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("https://changyan.sohu.com/upload/changyan.js",function(){
        window.changyan.api.config({appid:appid,conf:conf})});
      }
    })();
    </script>
    <script type="text/javascript" src="https://assets.changyan.sohu.com/upload/plugins/plugins.count.js"></script>
  





  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("RqLJeAHxgJYzXuXlSXDFYuQe-gzGzoHsz", "854t3N6xanB861Eu3tsCEWEP");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

  

</body>
</html>
